<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ›’ Fruits & Goods</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .fruit-card:hover { transform: translateY(-5px); }
        .cart-bounce { animation: bounce 0.3s ease; }
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-in { animation: slideIn 0.3s ease; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .blink { animation: blink 1s ease-in-out infinite; }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .payment-glow { animation: paymentGlow 1.5s ease-in-out infinite; }
        @keyframes paymentGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(234, 179, 8, 0.5); }
            50% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.8); }
        }
        .tab-active { border-bottom: 3px solid #22c55e; color: #22c55e; }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* WhatsApp Style Chat */
        .wa-bg-pattern {
            background-color: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c9c4bc' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .wa-bubble-out {
            background: #dcf8c6;
            border-radius: 8px 0 8px 8px;
            position: relative;
        }
        .wa-bubble-out::after {
            content: '';
            position: absolute;
            top: 0;
            right: -8px;
            border-width: 0 0 10px 10px;
            border-style: solid;
            border-color: transparent transparent transparent #dcf8c6;
        }
        
        .wa-bubble-in {
            background: #ffffff;
            border-radius: 0 8px 8px 8px;
            position: relative;
        }
        .wa-bubble-in::after {
            content: '';
            position: absolute;
            top: 0;
            left: -8px;
            border-width: 0 10px 10px 0;
            border-style: solid;
            border-color: transparent #ffffff transparent transparent;
        }
        
        .typing-dots span {
            animation: typingBounce 1.4s infinite ease-in-out;
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #128c7e;
            border-radius: 50%;
            margin: 0 2px;
        }
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        
        .wa-check { color: #8696a0; }
        .wa-check-read { color: #53bdeb; }
        
        .wa-time {
            font-size: 11px;
            color: rgba(0,0,0,0.45);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-orange-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[200] hidden">
        <div class="bg-white rounded-2xl p-8 text-center">
            <div class="w-12 h-12 border-4 border-green-500 border-t-transparent rounded-full spinner mx-auto mb-4"></div>
            <p class="text-gray-600" id="loadingText">Memproses...</p>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[90] p-4 hidden">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full fade-in max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <img src="https://raw.githubusercontent.com/faridridwan1378/varsha-catalog/main/gambar buah/logo-varsha.png" alt="Logo" class="w-32 h-32 object-contain mx-auto mb-2">
                <h2 class="text-2xl font-bold text-green-600">Fruits & Goods</h2>
                <p class="text-gray-500 text-sm">Welcome! Fresh fruits & more</p>
            </div>

            <div class="flex mb-6 bg-gray-100 rounded-xl p-1">
                <button onclick="switchAuthTab('login')" id="loginTab" class="flex-1 py-2 rounded-lg font-medium transition bg-white text-green-600 shadow">Masuk</button>
                <button onclick="switchAuthTab('register')" id="registerTab" class="flex-1 py-2 rounded-lg font-medium transition text-gray-500">Daftar</button>
            </div>

            <!-- Login Form -->
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Masuk Sebagai</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="loginRole" value="buyer" class="hidden peer" checked onchange="toggleLoginFieldByRole()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
                                <span class="text-2xl block mb-1">ğŸ›’</span>
                                <span class="font-medium text-gray-700 text-sm">Pembeli</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="loginRole" value="seller" class="hidden peer" onchange="toggleLoginFieldByRole()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-green-500 peer-checked:bg-green-50 transition">
                                <span class="text-2xl block mb-1">ğŸ‘¨â€ğŸ’¼</span>
                                <span class="font-medium text-gray-700 text-sm">Penjual</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="space-y-4">
                    <!-- Login Pembeli: No. Telepon -->
                    <div id="loginPhoneField">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“± No. Telepon</label>
                        <input type="tel" id="loginPhone" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="08123456789">
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”’ Password</label>
                            <input type="password" id="loginPasswordPhone" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Masukkan password">
                        </div>
                    </div>
                    <!-- Login Penjual: Email -->
                    <div id="loginEmailField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“§ Email</label>
                        <input type="email" id="loginEmail" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="email@contoh.com">
                        <p class="text-xs text-gray-400 mt-1">Gunakan email yang didaftarkan saat registrasi</p>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”’ Password</label>
                            <input type="password" id="loginPasswordEmail" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Masukkan password">
                        </div>
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full mt-6 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">
                    Masuk
                </button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Sebagai</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="userRole" value="buyer" class="hidden peer" checked onchange="toggleRegisterFields()">
                            <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
                                <span class="text-3xl block mb-1">ğŸ›’</span>
                                <span class="font-medium text-gray-700">Pembeli</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="userRole" value="seller" class="hidden peer" onchange="toggleRegisterFields()">
                            <div class="border-2 border-gray-200 rounded-xl p-4 text-center peer-checked:border-green-500 peer-checked:bg-green-50 transition">
                                <span class="text-3xl block mb-1">ğŸ‘¨â€ğŸ’¼</span>
                                <span class="font-medium text-gray-700">Penjual</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ‘¤ Nama Lengkap</label>
                        <input type="text" id="registerName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Nama Anda">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“± No. Telepon</label>
                        <input type="tel" id="registerPhone" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="08123456789">
                    </div>
                    <div id="registerEmailField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“§ Email</label>
                        <input type="email" id="registerEmail" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="email@contoh.com">
                    </div>
                    <div id="registerRefCodeField" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ” Reference Code</label>
                        <input type="text" id="registerRefCode" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none font-mono tracking-wider" placeholder="Masukkan kode referensi">
                        <p class="text-xs text-gray-400 mt-1">Minta kode referensi dari admin toko</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ Alamat</label>
                        <textarea id="registerAddress" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" rows="2" placeholder="Alamat lengkap"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”’ Password</label>
                        <input type="password" id="registerPassword" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Minimal 6 karakter">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”’ Konfirmasi Password</label>
                        <input type="password" id="registerPasswordConfirm" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Ulangi password">
                    </div>
                </div>
                <button onclick="handleRegister()" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-xl font-semibold hover:bg-orange-600 transition">
                    Daftar Sekarang
                </button>
            </div>

            <div id="authError" class="hidden mt-4 bg-red-50 text-red-600 p-3 rounded-lg text-sm whitespace-pre-line"></div>

            <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                <p class="text-xs text-gray-400">Â© 2025 <a href="https://rdwan.net" target="_blank" class="text-green-500 hover:text-green-600 hover:underline">rdwan.net</a></p>
            </div>

        </div>
    </div>

    <!-- Mode Selection -->
    <div id="modeSelection" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-lg w-full text-center">
            <div class="flex items-center justify-center gap-3 mb-2">
                <img src="https://raw.githubusercontent.com/faridridwan1378/varsha-catalog/main/gambar buah/logo-varsha.png" alt="Logo" class="w-32 h-32 object-contain">
                <h1 class="text-4xl font-bold text-green-600">Fruits & Goods</h1>
            </div>
            
            <div id="userInfoCard" class="bg-gradient-to-r from-green-50 to-orange-50 rounded-xl p-4 mb-4">
                <div class="flex items-center justify-center gap-3">
                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-xl font-bold" id="userAvatar">U</div>
                    <div class="text-left">
                        <p class="font-semibold text-gray-800" id="userName">User</p>
                        <p class="text-sm text-gray-500" id="userPhone">ğŸ“± 08123456789</p>
                        <span class="inline-block mt-1 text-xs px-2 py-1 rounded-full" id="userRoleBadge">Role</span>
                    </div>
                </div>
            </div>
            
            <div id="storageStatus" class="mb-6 p-3 rounded-xl text-sm">
                <div class="flex items-center justify-center gap-2 text-green-700 bg-green-100 rounded-xl p-3">
                    <span>â˜ï¸</span>
                    <span class="font-medium">Terhubung ke Firebase Cloud</span>
                </div>
            </div>
            
            <div id="modeButtons" class="grid grid-cols-1 gap-4"></div>

            <div class="flex items-center justify-center gap-4 mt-6">
                <button onclick="openChangePasswordModal()" class="text-blue-500 hover:text-blue-700 text-sm underline">
                    ğŸ” Ubah Password
                </button>
                <span class="text-gray-300">|</span>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-gray-600 text-sm underline">
                    ğŸšª Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ğŸ” Ubah Password</h3>
                <button onclick="closeChangePasswordModal()" class="text-2xl text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”’ Password Lama</label>
                    <input type="password" id="oldPassword" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Masukkan password lama">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”‘ Password Baru</label>
                    <input type="password" id="newPassword" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Minimal 6 karakter">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ”‘ Konfirmasi Password Baru</label>
                    <input type="password" id="confirmNewPassword" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Ulangi password baru">
                </div>
            </div>

            <div id="changePasswordError" class="hidden mt-4 bg-red-50 text-red-600 p-3 rounded-lg text-sm"></div>
            <div id="changePasswordSuccess" class="hidden mt-4 bg-green-50 text-green-600 p-3 rounded-lg text-sm"></div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeChangePasswordModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Batal</button>
                <button onclick="handleChangePassword()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold hover:bg-blue-600 transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Floating Chat Buttons Removed - Use WhatsApp buttons on orders instead -->
    <div id="floatingChatBuyer" class="fixed bottom-6 right-6 z-40 hidden" style="display:none !important;">
        <div id="chatListBuyer" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-xl shadow-2xl overflow-hidden mb-2">
            <!-- WhatsApp Style Header -->
            <div class="bg-[#075e54] text-white p-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-base">Chat</h3>
                        <p class="text-xs text-green-200">Pesanan Anda</p>
                    </div>
                </div>
            </div>
            <!-- Search Bar -->
            <div class="p-2 bg-[#f6f6f6]">
                <div class="bg-white rounded-lg px-3 py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" placeholder="Cari chat..." class="flex-1 text-sm outline-none bg-transparent">
                </div>
            </div>
            <div id="chatOrderListBuyer" class="max-h-72 overflow-y-auto bg-white"></div>
        </div>
        <button onclick="toggleChatListBuyer()" class="bg-[#25d366] hover:bg-[#128c7e] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            <span id="chatBadgeBuyer" class="absolute -top-1 -right-1 bg-[#25d366] text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden border-2 border-white">0</span>
        </button>
    </div>

    <!-- Floating Chat Seller Removed -->
    <div id="floatingChatSeller" class="fixed bottom-6 right-6 z-40 hidden" style="display:none !important;">
        <div id="chatListSeller" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-xl shadow-2xl overflow-hidden mb-2">
            <!-- WhatsApp Style Header -->
            <div class="bg-[#075e54] text-white p-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-base">Chat</h3>
                        <p class="text-xs text-green-200">Pembeli Anda</p>
                    </div>
                </div>
            </div>
            <!-- Search Bar -->
            <div class="p-2 bg-[#f6f6f6]">
                <div class="bg-white rounded-lg px-3 py-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                    </svg>
                    <input type="text" placeholder="Cari pembeli..." class="flex-1 text-sm outline-none bg-transparent">
                </div>
            </div>
            <div id="chatOrderListSeller" class="max-h-72 overflow-y-auto bg-white"></div>
        </div>
        <button onclick="toggleChatListSeller()" class="bg-[#25d366] hover:bg-[#128c7e] text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-110">
            <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            <span id="chatBadgeSeller" class="absolute -top-1 -right-1 bg-[#25d366] text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden border-2 border-white">0</span>
        </button>
    </div>

    <!-- Buyer Mode -->
    <div id="buyerMode" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ›’</span>
                    <div>
                        <h1 class="text-xl font-bold text-green-600" id="storeNameHeader">Fruits & Goods</h1>
                        <p class="text-xs text-gray-400">Halo, <span id="buyerNameHeader" class="font-semibold text-gray-600"></span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="setMode(null)" class="text-gray-500 hover:text-gray-700 text-sm">â† Menu</button>
                    <button onclick="toggleMyOrders()" class="relative bg-blue-500 text-white p-3 rounded-full hover:bg-blue-600 transition">
                        ğŸ“‹
                        <span id="notifCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">0</span>
                    </button>
                    <button onclick="toggleCart()" class="relative bg-orange-500 text-white p-3 rounded-full hover:bg-orange-600 transition">
                        ğŸ›’
                        <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Store Info Banner -->
        <div id="storeInfoBanner" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-4">
            <div class="container mx-auto flex items-center gap-4">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl overflow-hidden" id="storeLogoBanner">ğŸ›’</div>
                <div>
                    <h2 class="text-xl font-bold" id="storeNameBanner">Fruits & Goods</h2>
                    <p class="text-sm opacity-90" id="storeAddressBanner">ğŸ“ Alamat toko</p>
                    <p class="text-sm opacity-90" id="storePhoneBanner">ğŸ“ No. telepon</p>
                </div>
            </div>
        </div>

        <!-- Action Banner -->
        <div id="actionBanner" class="hidden bg-orange-500 text-white py-3 px-4 text-center cursor-pointer hover:bg-orange-600 transition blink" onclick="toggleMyOrders()">
            <span class="font-medium">âš ï¸ Ada pesanan menunggu konfirmasi Anda! Klik untuk melihat</span>
        </div>

        <main class="container mx-auto px-4 py-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ğŸŠ Pilih Produk Segar</h2>
            <div id="fruitsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            <div id="noProducts" class="hidden text-center py-12 text-gray-400">
                <span class="text-6xl block mb-4">ğŸ“¦</span>
                <p class="text-lg">Belum ada produk tersedia</p>
            </div>
        </main>

        <!-- Cart Sidebar -->
        <div id="cartSidebar" class="fixed top-0 right-0 h-full w-full md:w-96 bg-white shadow-2xl transform translate-x-full transition-transform z-50">
            <div class="h-full flex flex-col">
                <div class="p-4 bg-green-500 text-white flex justify-between items-center">
                    <h2 class="text-xl font-bold">ğŸ›’ Keranjang Belanja</h2>
                    <button onclick="toggleCart()" class="text-2xl hover:bg-green-600 rounded-full w-8 h-8">Ã—</button>
                </div>
                <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex justify-between text-lg font-bold mb-4">
                        <span>Total:</span>
                        <span id="cartTotal" class="text-green-600">Rp 0</span>
                    </div>
                    <button onclick="checkout()" id="checkoutBtn" class="w-full bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Checkout Sekarang
                    </button>
                </div>
            </div>
        </div>
        <div id="cartOverlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 hidden z-40"></div>

        <!-- My Orders Sidebar -->
        <div id="myOrdersSidebar" class="fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl transform translate-x-full transition-transform z-50">
            <div class="h-full flex flex-col">
                <div class="p-4 bg-blue-500 text-white flex justify-between items-center">
                    <h2 class="text-xl font-bold">ğŸ“‹ Pesanan Saya</h2>
                    <button onclick="toggleMyOrders()" class="text-2xl hover:bg-blue-600 rounded-full w-8 h-8">Ã—</button>
                </div>
                <div id="myOrdersList" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            </div>
        </div>
        <div id="myOrdersOverlay" onclick="toggleMyOrders()" class="fixed inset-0 bg-black/50 hidden z-40"></div>
    </div>

    <!-- Seller Mode -->
    <div id="sellerMode" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">ğŸ‘¨â€ğŸ’¼</span>
                    <div>
                        <h1 class="text-xl font-bold text-green-600">Dashboard Penjual</h1>
                        <p class="text-xs text-gray-400" id="sellerNameHeader"></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="setMode(null)" class="text-gray-500 hover:text-gray-700 text-sm">â† Menu</button>
                    <div class="flex items-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                        <span class="w-2 h-2 bg-green-500 rounded-full pulse"></span>
                        <span class="text-green-700 text-sm font-medium">Live</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Seller Tabs -->
        <div class="bg-white border-b">
            <div class="container mx-auto px-4">
                <div class="flex gap-4 overflow-x-auto">
                    <button onclick="switchSellerTab('orders')" id="tabOrders" class="py-4 px-2 font-medium text-gray-600 tab-active whitespace-nowrap">ğŸ“‹ Pesanan Masuk</button>
                    <button onclick="switchSellerTab('products')" id="tabProducts" class="py-4 px-2 font-medium text-gray-600 whitespace-nowrap">ğŸ“¦ Kelola Produk</button>
                    <button onclick="switchSellerTab('store')" id="tabStore" class="py-4 px-2 font-medium text-gray-600 whitespace-nowrap">ğŸª Pengaturan Toko</button>
                    <button onclick="switchSellerTab('header')" id="tabHeader" class="py-4 px-2 font-medium text-gray-600 whitespace-nowrap">ğŸ“ Kelola Header</button>
                </div>
            </div>
        </div>

        <main class="container mx-auto px-4 py-8">
            <!-- Orders Tab -->
            <div id="ordersTab">
                <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-8">
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <p class="text-gray-500 text-xs">Total Order</p>
                        <p id="statOrders" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <p class="text-gray-500 text-xs">Pending</p>
                        <p id="statPending" class="text-2xl font-bold text-yellow-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md border-2 border-amber-300">
                        <p class="text-gray-500 text-xs">ğŸ’° Tunggu Bayar</p>
                        <p id="statPayment" class="text-2xl font-bold text-amber-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <p class="text-gray-500 text-xs">Diproses</p>
                        <p id="statProcessing" class="text-2xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <p class="text-gray-500 text-xs">Selesai</p>
                        <p id="statCompleted" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md">
                        <p class="text-gray-500 text-xs">Dibatalkan</p>
                        <p id="statCancelled" class="text-2xl font-bold text-red-600">0</p>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-4 bg-gradient-to-r from-green-500 to-green-600 text-white flex justify-between items-center">
                        <h2 class="text-xl font-bold">ğŸ“‹ Daftar Order Masuk</h2>
                        <button onclick="clearAllOrders()" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded-lg text-sm">Hapus Semua</button>
                    </div>
                    <div id="ordersList" class="divide-y max-h-[65vh] overflow-y-auto"></div>
                    <div id="noOrders" class="p-12 text-center text-gray-400">
                        <span class="text-6xl block mb-4">ğŸ“­</span>
                        <p class="text-lg">Belum ada order masuk</p>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“¦ Kelola Produk</h2>
                    <div class="flex gap-2">
                        <button onclick="addSampleProducts()" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-orange-600 transition">
                            ğŸ Tambah Sample
                        </button>
                        <button onclick="openProductModal()" class="bg-green-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-600 transition">
                            + Tambah Produk
                        </button>
                    </div>
                </div>
                <div id="productsList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                <div id="noProductsSeller" class="hidden text-center py-12 text-gray-400">
                    <span class="text-6xl block mb-4">ğŸ“¦</span>
                    <p class="text-lg">Belum ada produk</p>
                    <p class="text-sm">Klik tombol "+ Tambah Produk" untuk menambah produk baru</p>
                </div>
            </div>

            <!-- Header Settings Tab -->
            <div id="headerTab" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“ Kelola Header</h2>
                    <button onclick="restoreHeaderFromFirebase()" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-600 transition flex items-center gap-2">
                        ğŸ”„ Restore dari Firebase
                    </button>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 max-w-2xl">
                    <!-- Preview Header -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">ğŸ‘ï¸ Preview Header</label>
                        <div id="headerPreview" class="rounded-xl overflow-hidden shadow-lg">
                            <div id="previewBanner" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-4">
                                <div class="flex items-center gap-4">
                                    <div id="previewLogo" class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl overflow-hidden">ğŸ›’</div>
                                    <div>
                                        <h2 id="previewStoreName" class="text-xl font-bold">Fruits & Goods</h2>
                                        <p id="previewTagline" class="text-sm opacity-90">Fresh fruits & more</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª Nama Header/Toko</label>
                            <input type="text" id="headerStoreName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Fruits & Goods" oninput="updateHeaderPreview()">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’¬ Tagline</label>
                            <input type="text" id="headerTagline" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Fresh fruits & more" oninput="updateHeaderPreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ Emoji Logo</label>
                            <input type="text" id="headerEmoji" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-3xl text-center" placeholder="ğŸ›’" maxlength="2" oninput="updateHeaderPreview()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ–¼ï¸ URL Logo (opsional)</label>
                            <input type="url" id="headerLogoUrl" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-sm" placeholder="https://example.com/logo.png" oninput="updateHeaderPreview()">
                        </div>
                    </div>

                    <hr class="my-6">

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ¨ Warna Banner</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="green" class="hidden peer" checked onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-green-500 peer-checked:ring-2 peer-checked:ring-green-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-green-500 to-green-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Hijau</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="orange" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-orange-500 peer-checked:ring-2 peer-checked:ring-orange-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Oranye</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="blue" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-blue-500 peer-checked:ring-2 peer-checked:ring-blue-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Biru</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="purple" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-purple-500 peer-checked:ring-2 peer-checked:ring-purple-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Ungu</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="red" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-red-500 peer-checked:ring-2 peer-checked:ring-red-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-red-500 to-red-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Merah</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="pink" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-pink-500 peer-checked:ring-2 peer-checked:ring-pink-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Pink</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="teal" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-teal-500 peer-checked:ring-2 peer-checked:ring-teal-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-teal-500 to-teal-600 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Teal</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="bannerColor" value="gray" class="hidden peer" onchange="updateHeaderPreview()">
                            <div class="border-2 border-gray-200 rounded-xl p-3 text-center peer-checked:border-gray-500 peer-checked:ring-2 peer-checked:ring-gray-200 transition">
                                <div class="w-full h-8 bg-gradient-to-r from-gray-700 to-gray-800 rounded-lg mb-2"></div>
                                <span class="text-sm text-gray-600">Abu-abu</span>
                            </div>
                        </label>
                    </div>

                    <button onclick="saveHeaderSettings()" class="w-full mt-6 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">
                        ğŸ’¾ Simpan Header
                    </button>
                </div>
            </div>

            <!-- Store Settings Tab -->
            <div id="storeTab" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸª Pengaturan Toko</h2>
                    <button onclick="restoreStoreFromFirebase()" class="bg-blue-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-600 transition flex items-center gap-2">
                        <span class="spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full" id="restoreSpinner"></span>
                        ğŸ”„ Restore dari Firebase
                    </button>
                </div>
                <div class="bg-white rounded-2xl shadow-lg p-6 max-w-2xl">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª Nama Toko</label>
                            <input type="text" id="storeName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Contoh: Toko Buah Pak Budi">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Alamat Toko</label>
                            <textarea id="storeAddress" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" rows="2" placeholder="Alamat lengkap toko"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ No. Telepon Toko</label>
                            <input type="tel" id="storePhone" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="08123456789">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ Emoji Toko</label>
                            <input type="text" id="storeLogo" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-3xl text-center" placeholder="ğŸ" maxlength="2" oninput="updateStoreLogoPreview()">
                        </div>
                    </div>

                    <!-- Logo Preview & URL -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                        <label class="block text-sm font-medium text-gray-700 mb-3">ğŸ–¼ï¸ Logo Toko</label>
                        <div class="flex items-center gap-4">
                            <div id="storeLogoPreview" class="w-24 h-24 bg-white border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center overflow-hidden shadow-sm">
                                <span class="text-5xl">ğŸ</span>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">URL Gambar Logo (opsional)</label>
                                <input type="url" id="storeLogoImage" class="w-full border-2 border-gray-200 rounded-xl px-4 py-2 focus:border-green-500 focus:outline-none text-sm" placeholder="https://example.com/logo.png" oninput="updateStoreLogoPreview()">
                                <p class="text-xs text-gray-400 mt-1">Jika diisi, gambar akan menggantikan emoji</p>
                            </div>
                        </div>
                    </div>

                    <hr class="my-6">

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ”‘ Kode Referensi Penjual</h3>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ” Reference Code</label>
                        <input type="text" id="referenceCode" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none font-mono text-lg tracking-wider" placeholder="Contoh: VARSHA2025">
                        <p class="text-xs text-gray-400 mt-1">Kode ini diperlukan untuk registrasi penjual baru. Bagikan hanya kepada orang yang dipercaya.</p>
                    </div>

                    <hr class="my-6">

                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’³ Informasi Rekening (untuk Pembayaran)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¦ Nama Bank</label>
                            <select id="bankName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none">
                                <option value="">Pilih Bank</option>
                                <option value="BCA">BCA</option>
                                <option value="BNI">BNI</option>
                                <option value="BRI">BRI</option>
                                <option value="Mandiri">Mandiri</option>
                                <option value="CIMB Niaga">CIMB Niaga</option>
                                <option value="Danamon">Danamon</option>
                                <option value="BSI">BSI</option>
                                <option value="Permata">Permata</option>
                                <option value="OCBC NISP">OCBC NISP</option>
                                <option value="GoPay">GoPay</option>
                                <option value="OVO">OVO</option>
                                <option value="DANA">DANA</option>
                                <option value="ShopeePay">ShopeePay</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’³ Nomor Rekening</label>
                            <input type="text" id="bankAccount" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="1234567890">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ Nama Pemilik Rekening</label>
                            <input type="text" id="bankAccountName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Nama sesuai rekening">
                        </div>
                    </div>

                    <button onclick="saveStoreSettings()" class="w-full mt-6 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">
                        ğŸ’¾ Simpan Pengaturan
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="productModalTitle">Tambah Produk</h3>
                <button onclick="closeProductModal()" class="text-2xl text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <div class="space-y-4">
                <!-- Preview Gambar -->
                <div class="text-center">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preview Produk</label>
                    <div id="productPreview" class="w-32 h-32 mx-auto border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center bg-gray-50 overflow-hidden">
                        <span class="text-5xl" id="previewEmoji">ğŸ</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ¨ Emoji</label>
                        <input type="text" id="productEmoji" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-2xl text-center focus:border-green-500 focus:outline-none" placeholder="ğŸ" maxlength="2" oninput="updateProductPreview()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“¦ Stok</label>
                        <input type="number" id="productStock" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="100" min="0">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ–¼ï¸ URL Gambar (opsional)</label>
                    <input type="url" id="productImage" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-sm" placeholder="https://example.com/gambar-buah.jpg" oninput="updateProductPreview()">
                    <p class="text-xs text-gray-400 mt-1">Jika diisi, gambar akan menggantikan emoji</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ Nama Produk</label>
                    <input type="text" id="productName" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="Contoh: Apel Merah">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ’° Harga (Rp)</label>
                        <input type="number" id="productPrice" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" placeholder="25000" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ Satuan</label>
                        <select id="productUnit" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none">
                            <option value="kg">per kg</option>
                            <option value="buah">per buah</option>
                            <option value="ikat">per ikat</option>
                            <option value="sisir">per sisir</option>
                            <option value="pack">per pack</option>
                            <option value="box">per box</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ğŸ“„ Deskripsi (opsional)</label>
                    <textarea id="productDescription" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" rows="2" placeholder="Deskripsi singkat produk..."></textarea>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="productActive" class="w-5 h-5 text-green-500 rounded" checked>
                    <label class="text-sm text-gray-700">Produk Aktif (tampil di toko)</label>
                </div>
            </div>

            <input type="hidden" id="productId">

            <div class="flex gap-3 mt-6">
                <button onclick="closeProductModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Batal</button>
                <button onclick="saveProduct()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Shipping Modal -->
    <div id="shippingModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full slide-in max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸšš Tambah Biaya Kirim</h3>
            <div id="shippingOrderInfo" class="bg-gray-50 rounded-xl p-4 mb-4"></div>
            <div id="shippingBuyerInfo" class="bg-blue-50 rounded-xl p-4 mb-4"></div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Biaya Kirim (Rp)</label>
                <input type="number" id="shippingCostInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-lg" placeholder="Contoh: 15000" min="0">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan untuk Pembeli (opsional)</label>
                <textarea id="sellerNoteInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none" rows="2" placeholder="Contoh: Pengiriman via GoSend"></textarea>
            </div>
            <div class="bg-green-50 rounded-xl p-4 mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span>Subtotal Belanja:</span>
                    <span id="modalSubtotal" class="font-medium">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm mb-1">
                    <span>Biaya Kirim:</span>
                    <span id="modalShipping" class="font-medium">Rp 0</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-green-600 border-t pt-2 mt-2">
                    <span>Total:</span>
                    <span id="modalTotal">Rp 0</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeShippingModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Batal</button>
                <button onclick="confirmOrderWithShipping()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">Kirim ke Pembeli</button>
            </div>
            <button onclick="confirmOrderWithShippingAndWA()" class="w-full mt-3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Kirim ke Pembeli + WhatsApp
            </button>
        </div>
    </div>

    <!-- Buyer Confirmation Modal -->
    <div id="buyerConfirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full slide-in">
            <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ“¦ Konfirmasi Pesanan</h3>
            <p class="text-gray-500 text-sm mb-4">Penjual telah menambahkan biaya kirim. Lanjutkan pesanan?</p>
            
            <div id="confirmOrderInfo" class="bg-gray-50 rounded-xl p-4 mb-4"></div>
            
            <div class="bg-green-50 rounded-xl p-4 mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span>Subtotal Belanja:</span>
                    <span id="confirmSubtotal" class="font-medium">Rp 0</span>
                </div>
                <div class="flex justify-between text-sm mb-1">
                    <span>Biaya Kirim:</span>
                    <span id="confirmShipping" class="font-medium text-orange-600">Rp 0</span>
                </div>
                <div class="flex justify-between text-lg font-bold text-green-600 border-t pt-2 mt-2">
                    <span>Total Bayar:</span>
                    <span id="confirmTotal">Rp 0</span>
                </div>
            </div>

            <div id="confirmSellerNote" class="hidden bg-blue-50 rounded-xl p-3 mb-4">
                <p class="text-xs text-blue-600 font-medium">ğŸ’¬ Catatan dari Penjual:</p>
                <p id="confirmNoteText" class="text-sm text-blue-800"></p>
            </div>

            <div id="confirmBankInfo" class="bg-amber-50 rounded-xl p-3 mb-4">
                <p class="text-xs text-amber-700 font-medium">ğŸ’³ Transfer ke:</p>
                <p class="text-sm text-amber-800 font-mono" id="confirmBankDetails">Bank BCA: 1234567890 a.n. Toko Buah</p>
            </div>

            <div class="flex gap-3">
                <button onclick="cancelOrderByBuyer()" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold hover:bg-red-600 transition">âŒ Batalkan</button>
                <button onclick="confirmOrderByBuyer()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">ğŸ’³ Lanjutkan & Bayar</button>
            </div>
            <button onclick="confirmOrderByBuyerAndWA()" class="w-full mt-3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Lanjutkan & Bayar + WhatsApp ke Penjual
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full slide-in">
            <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸ’° Konfirmasi Pembayaran</h3>
            <p class="text-gray-500 text-sm mb-4">Apakah pembayaran dari pembeli sudah diterima?</p>
            
            <div id="paymentOrderInfo" class="bg-gray-50 rounded-xl p-4 mb-4"></div>
            
            <div class="bg-amber-50 rounded-xl p-4 mb-4">
                <div class="flex justify-between text-lg font-bold text-amber-600">
                    <span>Total Diterima:</span>
                    <span id="paymentTotal">Rp 0</span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closePaymentModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Batal</button>
                <button onclick="confirmPaymentReceived()" class="flex-1 bg-green-500 text-white py-3 rounded-xl font-semibold hover:bg-green-600 transition">âœ… Pembayaran Diterima</button>
            </div>
            <button onclick="confirmPaymentReceivedAndWA()" class="w-full mt-3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Konfirmasi + WhatsApp ke Pembeli
            </button>
        </div>
    </div>

    <!-- Shipping Confirm Modal -->
    <div id="shippingConfirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full slide-in">
            <h3 class="text-xl font-bold text-gray-800 mb-2">ğŸšš Konfirmasi Pengiriman</h3>
            <p class="text-gray-500 text-sm mb-4">Masukkan detail pengiriman pesanan</p>
            
            <div id="shippingConfirmOrderInfo" class="bg-gray-50 rounded-xl p-4 mb-4"></div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Kurir / Ekspedisi</label>
                <select id="courierSelect" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                    <option value="gojek">GoSend / Gojek</option>
                    <option value="grab">GrabExpress</option>
                    <option value="jne">JNE</option>
                    <option value="jnt">J&T Express</option>
                    <option value="sicepat">SiCepat</option>
                    <option value="anteraja">AnterAja</option>
                    <option value="kurir_toko">Kurir Toko</option>
                    <option value="ambil_sendiri">Ambil Sendiri</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Resi (opsional)</label>
                <input type="text" id="trackingNumberInput" class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none" placeholder="Contoh: JNE123456789">
            </div>

            <div class="flex gap-3">
                <button onclick="closeShippingConfirmModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-300 transition">Batal</button>
                <button onclick="confirmShipping()" class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold hover:bg-blue-600 transition">ğŸšš Konfirmasi Dikirim</button>
            </div>
            <button onclick="confirmShippingAndWA()" class="w-full mt-3 bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Konfirmasi Kirim + WhatsApp ke Pembeli
            </button>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4 text-center slide-in">
            <span class="text-6xl block mb-4">âœ…</span>
            <h3 class="text-2xl font-bold text-green-600 mb-2">Order Berhasil!</h3>
            <p class="text-gray-500 mb-2">Order Anda telah dikirim ke penjual</p>
            <p class="text-sm text-gray-400 mb-6">ID Order: <span id="orderIdDisplay" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
            <button onclick="closeSuccessModal()" class="bg-green-500 text-white px-6 py-2 rounded-xl font-semibold hover:bg-green-600">Tutup</button>
        </div>
    </div>

    <!-- Chat Modal Removed - Using WhatsApp only -->
    <div id="chatModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-2 md:p-4" style="display:none !important;">
        <div class="bg-white rounded-lg w-full max-w-md h-[90vh] md:h-[85vh] flex flex-col slide-in shadow-2xl overflow-hidden">
            <!-- WhatsApp Header -->
            <div class="bg-[#075e54] text-white px-3 py-2 flex items-center gap-3">
                <button onclick="closeChatModal()" class="text-white hover:bg-white/10 rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold text-lg" id="chatPartnerAvatar">P</div>
                <div class="flex-1">
                    <p class="font-medium text-base" id="chatPartnerName">Partner</p>
                    <p class="text-xs text-green-200" id="chatPartnerStatus">online</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="hover:bg-white/10 rounded-full p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.9 14.3H15l-.3-.3c1-1.1 1.6-2.7 1.6-4.3 0-3.7-3-6.7-6.7-6.7S3 6 3 9.7s3 6.7 6.7 6.7c1.6 0 3.2-.6 4.3-1.6l.3.3v.8l5.1 5.1 1.5-1.5-5-5.2zm-6.2 0c-2.6 0-4.6-2.1-4.6-4.6s2.1-4.6 4.6-4.6 4.6 2.1 4.6 4.6-2 4.6-4.6 4.6z"/>
                        </svg>
                    </button>
                    <button class="hover:bg-white/10 rounded-full p-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 7a2 2 0 1 0-.001-4.001A2 2 0 0 0 12 7zm0 2a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 9zm0 6a2 2 0 1 0-.001 3.999A2 2 0 0 0 12 15z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Order Info Bar -->
            <div class="bg-[#128c7e] text-white px-4 py-2 flex items-center justify-between text-sm">
                <div class="flex items-center gap-2">
                    <span>ğŸ“‹</span>
                    <span id="chatOrderId" class="font-mono">ORD123</span>
                </div>
                <span id="chatOrderStatus" class="text-xs bg-white/20 px-2 py-0.5 rounded-full">Status</span>
            </div>
            
            <!-- Chat Messages - WhatsApp Style -->
            <div id="chatMessages" class="flex-1 overflow-y-auto wa-bg-pattern px-3 py-2">
                <!-- Messages will be loaded here -->
                <div class="text-center py-8">
                    <div class="inline-block bg-[#fcf4cb] rounded-lg px-4 py-2 text-sm text-[#54656f] shadow-sm">
                        <span class="text-lg block mb-1">ğŸ”’</span>
                        Pesan dan panggilan terenkripsi end-to-end.<br>
                        Tidak ada pihak ketiga yang dapat membaca.
                    </div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="hidden px-4 py-2 bg-[#e5ddd5]">
                <div class="inline-flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="text-sm text-gray-500">mengetik...</span>
                </div>
            </div>
            
            <!-- WhatsApp Style Input -->
            <div class="bg-[#f0f0f0] px-2 py-2 flex items-center gap-2">
                <button class="text-[#54656f] hover:bg-white/50 rounded-full p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9.153 11.603c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962zm-3.204 1.362c-.026-.307-.131 5.218 6.063 5.551 6.066-.25 6.066-5.551 6.066-5.551-6.078 1.416-12.129 0-12.129 0zm11.363 1.108s-.669 1.959-5.051 1.959c-3.505 0-5.388-1.164-5.607-1.959 0 0 5.912 1.055 10.658 0zM11.804 1.011C5.609 1.011.978 6.033.978 12.228s4.826 10.761 11.021 10.761S23.02 18.423 23.02 12.228c.001-6.195-5.021-11.217-11.216-11.217zM12 21.354c-5.273 0-9.381-3.886-9.381-9.159s3.942-9.548 9.215-9.548 9.548 4.275 9.548 9.548c-.001 5.272-4.109 9.159-9.382 9.159zm3.108-9.751c.795 0 1.439-.879 1.439-1.962s-.644-1.962-1.439-1.962-1.439.879-1.439 1.962.644 1.962 1.439 1.962z"/>
                    </svg>
                </button>
                <button class="text-[#54656f] hover:bg-white/50 rounded-full p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M1.816 15.556v.002c0 1.502.584 2.912 1.646 3.972s2.472 1.647 3.974 1.647a5.58 5.58 0 0 0 3.972-1.645l9.547-9.548c.769-.768 1.147-1.767 1.058-2.817-.079-.968-.548-1.927-1.319-2.698-1.594-1.592-4.068-1.711-5.517-.262l-7.916 7.915c-.881.881-.792 2.25.214 3.261.959.958 2.423 1.053 3.263.215l5.511-5.512c.28-.28.267-.722.053-.936l-.244-.244c-.191-.191-.567-.349-.957.04l-5.506 5.506c-.18.18-.635.127-.976-.214-.098-.097-.576-.613-.213-.973l7.915-7.917c.818-.817 2.267-.699 3.23.262.5.501.802 1.1.849 1.685.051.573-.156 1.111-.589 1.543l-9.547 9.549a3.97 3.97 0 0 1-2.829 1.171 3.975 3.975 0 0 1-2.83-1.173 3.973 3.973 0 0 1-1.172-2.828c0-1.071.415-2.076 1.172-2.83l7.209-7.211c.157-.157.264-.579.028-.814L11.5 4.36a.572.572 0 0 0-.834.018l-7.205 7.207a5.577 5.577 0 0 0-1.645 3.971z"/>
                    </svg>
                </button>
                <div class="flex-1 relative">
                    <input type="text" id="chatInput" 
                        class="w-full bg-white rounded-full px-4 py-2.5 pr-12 focus:outline-none text-[15px] shadow-sm" 
                        placeholder="Ketik pesan" 
                        onkeypress="if(event.key==='Enter')sendChatMessage()"
                        oninput="handleTyping()">
                </div>
                <button onclick="sendChatMessage()" class="bg-[#00a884] hover:bg-[#008f72] text-white rounded-full p-2.5 shadow-lg transition-all">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC_tw6X6MnWf2WN22m-p2BeSTYdxsD1bAA",
            authDomain: "varsha-multi-market.firebaseapp.com",
            projectId: "varsha-multi-market",
            storageBucket: "varsha-multi-market.firebasestorage.app",
            messagingSenderId: "1086884848584",
            appId: "1:1086884848584:web:9aa4019c86d26d2ac216fd"
        };

        let db = null;
        let auth = null;
        let currentUser = null;
        let currentUserData = null;
        let storeData = null;
        let productsCache = [];
        let ordersCache = [];
        let unsubscribeOrders = null;
        let unsubscribeProducts = null;

        // Initialize Firebase
        function initFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(DEFAULT_FIREBASE_CONFIG);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData(user.uid);
                        showModeSelection();
                    } else {
                        currentUser = null;
                        currentUserData = null;
                        showAuthModal();
                    }
                });
                
                // Update sync status
                updateSyncStatus('connected');
            } catch (e) {
                console.error('Firebase init error:', e);
                updateSyncStatus('error', e.message);
            }
        }

        function updateSyncStatus(status, message = '') {
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            const syncStatus = document.getElementById('syncStatus');
            
            if (!syncIcon || !syncText || !syncStatus) return;
            
            switch (status) {
                case 'connected':
                    syncIcon.textContent = 'âœ…';
                    syncText.textContent = 'Terhubung ke Firebase Cloud';
                    syncStatus.className = 'mt-4 p-3 rounded-xl bg-green-50 text-center';
                    syncText.className = 'text-sm text-green-700';
                    break;
                case 'syncing':
                    syncIcon.textContent = 'ğŸ”„';
                    syncText.textContent = 'Menyinkronkan...';
                    syncStatus.className = 'mt-4 p-3 rounded-xl bg-blue-50 text-center';
                    syncText.className = 'text-sm text-blue-700';
                    break;
                case 'error':
                    syncIcon.textContent = 'âŒ';
                    syncText.textContent = 'Gagal terhubung: ' + message;
                    syncStatus.className = 'mt-4 p-3 rounded-xl bg-red-50 text-center';
                    syncText.className = 'text-sm text-red-700';
                    break;
                case 'offline':
                    syncIcon.textContent = 'ğŸ“´';
                    syncText.textContent = 'Mode Offline';
                    syncStatus.className = 'mt-4 p-3 rounded-xl bg-gray-50 text-center';
                    syncText.className = 'text-sm text-gray-600';
                    break;
            }
        }

        async function syncWithFirebase() {
            const syncBtn = document.getElementById('syncBtn');
            const syncSpinner = document.getElementById('syncSpinner');
            
            // Show loading
            syncBtn.disabled = true;
            syncSpinner.classList.remove('hidden');
            updateSyncStatus('syncing');
            
            try {
                // Test Firestore connection
                const testDoc = await db.collection('_test').doc('connection').get();
                
                // Check stores collection
                const storesSnapshot = await db.collection('stores').get();
                const storesCount = storesSnapshot.size;
                
                // Check products collection
                const productsSnapshot = await db.collection('products').get();
                const productsCount = productsSnapshot.size;
                
                // Check orders collection
                const ordersSnapshot = await db.collection('orders').get();
                const ordersCount = ordersSnapshot.size;
                
                // Check users collection
                const usersSnapshot = await db.collection('users').get();
                const usersCount = usersSnapshot.size;
                
                updateSyncStatus('connected');
                
                // Show sync result
                alert('âœ… Sync Berhasil!');
                
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', error.code || error.message);
                
                if (error.code === 'permission-denied') {
                    alert('âŒ Sync Gagal!\n\nFirestore Rules tidak mengizinkan akses.\n\nSolusi:\n1. Buka Firebase Console\n2. Firestore Database â†’ Rules\n3. Ubah ke:\n\nrules_version = "2";\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /{document=**} {\n      allow read, write: if true;\n    }\n  }\n}');
                } else if (error.code === 'unavailable') {
                    alert('âŒ Sync Gagal!\n\nTidak dapat terhubung ke Firebase.\n\nPeriksa:\nâ€¢ Koneksi internet\nâ€¢ Firewall/VPN');
                } else {
                    alert('âŒ Sync Gagal!\n\n' + (error.message || error.code));
                }
            } finally {
                syncBtn.disabled = false;
                syncSpinner.classList.add('hidden');
            }
        }

        // ==================== AUTH FUNCTIONS ====================
        function showAuthModal() {
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('authModal').classList.add('flex');
            document.getElementById('modeSelection').classList.add('hidden');
        }

        function showModeSelection() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('authModal').classList.remove('flex');
            document.getElementById('modeSelection').classList.remove('hidden');
            updateUserUI();
            updateModeButtons();
        }

        function switchAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            if (tab === 'login') {
                loginTab.classList.add('bg-white', 'text-green-600', 'shadow');
                loginTab.classList.remove('text-gray-500');
                registerTab.classList.remove('bg-white', 'text-green-600', 'shadow');
                registerTab.classList.add('text-gray-500');
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                registerTab.classList.add('bg-white', 'text-green-600', 'shadow');
                registerTab.classList.remove('text-gray-500');
                loginTab.classList.remove('bg-white', 'text-green-600', 'shadow');
                loginTab.classList.add('text-gray-500');
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
            document.getElementById('authError').classList.add('hidden');
        }

        function toggleRegisterFields() {
            const role = document.querySelector('input[name="userRole"]:checked').value;
            document.getElementById('registerEmailField').classList.toggle('hidden', role !== 'seller');
            document.getElementById('registerRefCodeField').classList.toggle('hidden', role !== 'seller');
        }

        // Toggle login field berdasarkan role
        function toggleLoginFieldByRole() {
            const role = document.querySelector('input[name="loginRole"]:checked').value;
            const phoneField = document.getElementById('loginPhoneField');
            const emailField = document.getElementById('loginEmailField');

            if (role === 'buyer') {
                // Pembeli login dengan No. Telepon
                phoneField.classList.remove('hidden');
                emailField.classList.add('hidden');
            } else {
                // Penjual login dengan Email
                emailField.classList.remove('hidden');
                phoneField.classList.add('hidden');
            }
        }

        function formatPhoneForEmail(phone, role = '') {
            const cleanPhone = phone.replace(/\D/g, '');
            return role ? `${cleanPhone}_${role}@fruitsgoods.app` : `${cleanPhone}@fruitsgoods.app`;
        }

        function showLoading(text = 'Memproses...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        async function handleLogin() {
            const role = document.querySelector('input[name="loginRole"]:checked').value;
            const roleText = role === 'buyer' ? 'Pembeli' : 'Penjual';

            if (role === 'seller') {
                // ============ PENJUAL: Login dengan Email ============
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPasswordEmail').value;
                
                if (!email || !password) {
                    showAuthError('Email dan password wajib diisi!');
                    return;
                }

                showLoading('Sedang masuk...');

                try {
                    console.log('Seller login with email:', email);
                    await auth.signInWithEmailAndPassword(email, password);
                    console.log('Login success!');
                    hideLoading();
                    return;
                } catch (e) {
                    console.log('Login failed:', e.code);
                    let message = 'Login gagal. ';
                    if (e.code === 'auth/user-not-found') {
                        message = `Email "${email}" tidak terdaftar!\n\nPastikan email sesuai dengan yang didaftarkan.`;
                    } else if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
                        message = `Password salah!\n\nEmail: ${email}`;
                    } else if (e.code === 'auth/invalid-email') {
                        message = 'Format email tidak valid!';
                    } else if (e.code === 'auth/too-many-requests') {
                        message = 'Terlalu banyak percobaan login. Coba lagi dalam beberapa menit.';
                    } else if (e.code === 'auth/network-request-failed') {
                        message = 'Gagal terhubung ke server. Periksa koneksi internet.';
                    } else {
                        message = `Error: ${e.code}\n${e.message}`;
                    }
                    showAuthError(message);
                    hideLoading();
                    return;
                }
            } else {
                // ============ PEMBELI: Login dengan No. Telepon ============
                const phone = document.getElementById('loginPhone').value.trim();
                const password = document.getElementById('loginPasswordPhone').value;

                if (!phone || !password) {
                    showAuthError('No. Telepon dan password wajib diisi!');
                    return;
                }

                showLoading('Sedang masuk...');

                const cleanPhone = phone.replace(/\D/g, '');
                
                // Try multiple email formats for buyer
                const emailFormats = [
                    `${cleanPhone}_buyer@fruitsgoods.app`,
                    `${phone}_buyer@fruitsgoods.app`,
                    `${cleanPhone}@fruitsgoods.app`,
                    `${phone}@fruitsgoods.app`,
                    `${cleanPhone}_buyer@tokobuah.app`,
                    `${cleanPhone}@tokobuah.app`
                ];
                
                let lastError = null;
                
                for (const email of emailFormats) {
                    try {
                        console.log('Trying login with:', email);
                        await auth.signInWithEmailAndPassword(email, password);
                        console.log('Login success with:', email);
                        hideLoading();
                        return;
                    } catch (e) {
                        console.log('Failed with:', email, e.code);
                        lastError = e;
                        // Continue to next format if user not found
                        if (e.code !== 'auth/user-not-found') {
                            // If it's password error, don't try other formats
                            break;
                        }
                    }
                }
                
                // All formats failed
                let message = 'Login gagal. ';
                if (lastError) {
                    if (lastError.code === 'auth/user-not-found') {
                        message = `No. Telepon ${phone} belum terdaftar sebagai Pembeli!\n\nSilakan daftar terlebih dahulu.`;
                    } else if (lastError.code === 'auth/wrong-password' || lastError.code === 'auth/invalid-credential') {
                        message = `Password salah!\n\nPastikan password sesuai.`;
                    } else if (lastError.code === 'auth/too-many-requests') {
                        message = 'Terlalu banyak percobaan login. Coba lagi dalam beberapa menit.';
                    } else if (lastError.code === 'auth/network-request-failed') {
                        message = 'Gagal terhubung ke server. Periksa koneksi internet.';
                    } else {
                        message = `Error: ${lastError.code}\n${lastError.message}`;
                    }
                }
                showAuthError(message);
                hideLoading();
            }
        }

        async function handleRegister() {
            const name = document.getElementById('registerName').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            const address = document.getElementById('registerAddress').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const role = document.querySelector('input[name="userRole"]:checked').value;
            const email = role === 'seller' ? document.getElementById('registerEmail').value.trim() : '';
            const refCode = role === 'seller' ? document.getElementById('registerRefCode').value.trim() : '';

            if (!name || !phone || !password) {
                showAuthError('Nama, No. Telepon, dan password wajib diisi!');
                return;
            }

            if (role === 'seller' && !email) {
                showAuthError('Email wajib diisi untuk penjual!');
                return;
            }

            if (role === 'seller' && !refCode) {
                showAuthError('Reference Code wajib diisi untuk penjual!');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password minimal 6 karakter!');
                return;
            }

            if (password !== passwordConfirm) {
                showAuthError('Password dan konfirmasi tidak cocok!');
                return;
            }

            showLoading('Memeriksa data...');

            // Validasi Reference Code untuk penjual
            if (role === 'seller') {
                try {
                    const storeDoc = await db.collection('stores').doc(STORE_ID).get();
                    if (storeDoc.exists) {
                        const storeData = storeDoc.data();
                        const validRefCode = storeData.referenceCode || '';
                        
                        if (!validRefCode) {
                            hideLoading();
                            showAuthError('Toko belum memiliki Reference Code. Hubungi admin untuk setup Reference Code terlebih dahulu.');
                            return;
                        }
                        
                        if (refCode !== validRefCode) {
                            hideLoading();
                            showAuthError('Reference Code tidak valid!\n\nPastikan Anda memasukkan kode yang benar dari admin toko.');
                            return;
                        }
                    } else {
                        // Toko belum ada, ini adalah penjual pertama - tidak perlu reference code
                        console.log('Toko belum ada, membuat toko baru...');
                    }
                } catch (error) {
                    console.error('Error checking reference code:', error);
                    hideLoading();
                    showAuthError('Gagal memverifikasi Reference Code. Periksa koneksi internet.');
                    return;
                }
            }

            try {
                // Check if phone + role already exists in Firestore
                const cleanPhone = phone.replace(/\D/g, '');
                const existingUsers = await db.collection('users')
                    .where('phone', '==', phone)
                    .where('role', '==', role)
                    .get();

                if (!existingUsers.empty) {
                    const roleText = role === 'buyer' ? 'Pembeli' : 'Penjual';
                    showAuthError(`No. Telepon ${phone} sudah terdaftar sebagai ${roleText}!`);
                    hideLoading();
                    return;
                }

                showLoading('Mendaftarkan akun...');

                // Seller: gunakan email yang diinput langsung
                // Buyer: generate email dari nomor telepon
                const authEmail = role === 'seller' ? email : formatPhoneForEmail(phone, role);
                const userCredential = await auth.createUserWithEmailAndPassword(authEmail, password);
                const user = userCredential.user;
                
                await db.collection('users').doc(user.uid).set({
                    id: user.uid,
                    name: name,
                    email: email,
                    phone: phone,
                    address: address,
                    role: role,
                    createdAt: Date.now()
                });

                // Untuk seller, cek apakah toko utama sudah ada
                // Jika belum, buat toko utama. Jika sudah, tidak perlu buat baru
                if (role === 'seller') {
                    const storeDoc = await db.collection('stores').doc(STORE_ID).get();
                    if (!storeDoc.exists) {
                        // Hanya create jika belum ada toko sama sekali
                        await db.collection('stores').doc(STORE_ID).set({
                            id: STORE_ID,
                            name: 'Fruits & Goods',
                            address: address,
                            phone: phone,
                            logo: 'ğŸ›’',
                            bankName: '',
                            bankAccount: '',
                            bankAccountName: '',
                            createdAt: Date.now(),
                            createdBy: user.uid
                        });
                    }
                }
            } catch (error) {
                let message = 'Pendaftaran gagal. ';
                if (error.code === 'auth/email-already-in-use') {
                    const roleText = role === 'buyer' ? 'Pembeli' : 'Penjual';
                    message = `No. Telepon sudah terdaftar sebagai ${roleText}!`;
                } else {
                    message += error.message;
                }
                showAuthError(message);
            } finally {
                hideLoading();
            }
        }

        async function loadUserData(userId) {
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) {
                currentUserData = doc.data();
            }
        }

        async function handleLogout() {
            showLoading('Keluar...');
            try {
                await auth.signOut();
            } finally {
                hideLoading();
            }
        }

        function updateUserUI() {
            if (!currentUserData) return;
            
            const initial = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : 'U';
            const roleColor = currentUserData.role === 'seller' ? 'bg-green-500' : 'bg-orange-500';
            const roleBg = currentUserData.role === 'seller' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700';
            const roleText = currentUserData.role === 'seller' ? 'ğŸ‘¨â€ğŸ’¼ Penjual' : 'ğŸ›’ Pembeli';
            
            document.getElementById('userAvatar').textContent = initial;
            document.getElementById('userAvatar').className = `w-12 h-12 ${roleColor} rounded-full flex items-center justify-center text-white text-xl font-bold`;
            document.getElementById('userName').textContent = currentUserData.name || 'User';
            document.getElementById('userPhone').textContent = 'ğŸ“± ' + (currentUserData.phone || '-');
            document.getElementById('userRoleBadge').textContent = roleText;
            document.getElementById('userRoleBadge').className = `inline-block mt-1 text-xs px-2 py-1 rounded-full ${roleBg}`;
        }

        function updateModeButtons() {
            const container = document.getElementById('modeButtons');
            
            if (currentUserData?.role === 'seller') {
                container.innerHTML = `
                    <button onclick="setMode('seller')" class="bg-gradient-to-r from-green-400 to-green-500 text-white p-6 rounded-2xl hover:from-green-500 hover:to-green-600 transition-all shadow-lg">
                        <span class="text-5xl block mb-3">ğŸ‘¨â€ğŸ’¼</span>
                        <span class="text-xl font-semibold block">Buka Dashboard</span>
                        <span class="text-sm opacity-80">Kelola produk & pesanan</span>
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="setMode('buyer')" class="bg-gradient-to-r from-orange-400 to-orange-500 text-white p-6 rounded-2xl hover:from-orange-500 hover:to-orange-600 transition-all shadow-lg">
                        <span class="text-5xl block mb-3">ğŸ›’</span>
                        <span class="text-xl font-semibold block">Mulai Belanja</span>
                        <span class="text-sm opacity-80">Pilih buah segar</span>
                    </button>
                `;
            }
        }

        // ==================== MAIN APP ====================
        let cart = [];
        let currentMode = null;
        let currentOrderForShipping = null;
        let currentOrderForConfirm = null;
        let currentOrderForPayment = null;
        let currentOrderForShippingConfirm = null;
        let editingProductId = null;

        function formatRupiah(num) {
            return 'Rp ' + num.toLocaleString('id-ID');
        }

        async function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('modeSelection').classList.toggle('hidden', mode !== null);
            document.getElementById('buyerMode').classList.toggle('hidden', mode !== 'buyer');
            document.getElementById('sellerMode').classList.toggle('hidden', mode !== 'seller');

            if (mode === 'buyer') {
                document.getElementById('buyerNameHeader').textContent = currentUserData?.name || 'Pembeli';
                await loadStoreForBuyer();
                loadProductsForBuyer();
                loadOrdersForBuyer();
                renderCart();
            } else if (mode === 'seller') {
                document.getElementById('sellerNameHeader').textContent = currentUserData?.name || 'Penjual';
                await loadStoreSettings();
                loadProductsForSeller();
                loadOrdersForSeller();
            }
        }

        // ==================== STORE FUNCTIONS ====================
        const STORE_ID = 'main_store'; // Single store ID untuk semua admin

        async function loadStoreForBuyer() {
            // Load the single main store
            const doc = await db.collection('stores').doc(STORE_ID).get();
            if (doc.exists) {
                storeData = doc.data();
                
                // Use header settings if available, fallback to store settings
                const displayName = storeData.headerName || storeData.name || 'Fruits & Goods';
                const tagline = storeData.tagline || '';
                const bannerColor = storeData.bannerColor || 'green';
                const logoEmoji = storeData.headerEmoji || storeData.logo || 'ğŸ›’';
                const logoUrl = storeData.headerLogoUrl || storeData.logoImage || '';
                
                // Update header
                document.getElementById('storeNameHeader').textContent = displayName;
                
                // Update banner name and info
                document.getElementById('storeNameBanner').textContent = displayName;
                document.getElementById('storeAddressBanner').textContent = tagline ? tagline : ('ğŸ“ ' + (storeData.address || 'Alamat toko'));
                document.getElementById('storePhoneBanner').textContent = tagline ? ('ğŸ“ ' + (storeData.address || '')) : ('ğŸ“ ' + (storeData.phone || 'No. telepon'));
                
                // Update banner color
                const bannerColors = {
                    green: 'bg-gradient-to-r from-green-500 to-green-600',
                    orange: 'bg-gradient-to-r from-orange-500 to-orange-600',
                    blue: 'bg-gradient-to-r from-blue-500 to-blue-600',
                    purple: 'bg-gradient-to-r from-purple-500 to-purple-600',
                    red: 'bg-gradient-to-r from-red-500 to-red-600',
                    pink: 'bg-gradient-to-r from-pink-500 to-pink-600',
                    teal: 'bg-gradient-to-r from-teal-500 to-teal-600',
                    gray: 'bg-gradient-to-r from-gray-700 to-gray-800'
                };
                const bannerEl = document.getElementById('storeInfoBanner');
                bannerEl.className = `${bannerColors[bannerColor] || bannerColors.green} text-white py-4 px-4`;
                
                // Update logo banner - support image or emoji
                const logoBanner = document.getElementById('storeLogoBanner');
                if (logoUrl) {
                    logoBanner.innerHTML = `<img src="${logoUrl}" alt="Logo" class="w-full h-full object-cover rounded-full" onerror="this.outerHTML='${logoEmoji}'">`;
                } else {
                    logoBanner.textContent = logoEmoji;
                }
            }
        }

        async function loadStoreSettings() {
            if (!currentUser) return;
            
            try {
                // Load single main store (shared by all admins)
                let doc = await db.collection('stores').doc(STORE_ID).get();
                
                // Jika main_store tidak ada, cari dokumen lain dan migrasi
                if (!doc.exists) {
                    console.log('main_store tidak ditemukan, mencari dokumen lain...');
                    const allStores = await db.collection('stores').limit(1).get();
                    
                    if (!allStores.empty) {
                        const existingStore = allStores.docs[0];
                        console.log('Ditemukan store dengan ID:', existingStore.id);
                        
                        // Migrasi data ke main_store
                        const existingData = existingStore.data();
                        await db.collection('stores').doc(STORE_ID).set({
                            ...existingData,
                            id: STORE_ID,
                            migratedFrom: existingStore.id,
                            migratedAt: Date.now()
                        });
                        
                        // Load ulang dari main_store
                        doc = await db.collection('stores').doc(STORE_ID).get();
                        console.log('Data berhasil dimigrasi ke main_store');
                    }
                }
                
                if (doc.exists) {
                    storeData = doc.data();
                    console.log('Store data loaded:', storeData);
                    
                    // Populate form fields
                    document.getElementById('storeName').value = storeData.name || '';
                    document.getElementById('storeAddress').value = storeData.address || '';
                    document.getElementById('storePhone').value = storeData.phone || '';
                    document.getElementById('storeLogo').value = storeData.logo || 'ğŸ';
                    document.getElementById('storeLogoImage').value = storeData.logoImage || '';
                    document.getElementById('bankName').value = storeData.bankName || '';
                    document.getElementById('bankAccount').value = storeData.bankAccount || '';
                    document.getElementById('bankAccountName').value = storeData.bankAccountName || '';
                    document.getElementById('referenceCode').value = storeData.referenceCode || '';
                    
                    // Update preview
                    updateStoreLogoPreview();
                    
                    // Also load header settings if on header tab
                    if (storeData.headerName) {
                        document.getElementById('headerStoreName').value = storeData.headerName || storeData.name || '';
                        document.getElementById('headerTagline').value = storeData.tagline || '';
                        document.getElementById('headerEmoji').value = storeData.headerEmoji || storeData.logo || 'ğŸ›’';
                        document.getElementById('headerLogoUrl').value = storeData.headerLogoUrl || '';
                        
                        // Set banner color radio
                        const bannerColor = storeData.bannerColor || 'green';
                        const colorRadio = document.querySelector(`input[name="bannerColor"][value="${bannerColor}"]`);
                        if (colorRadio) colorRadio.checked = true;
                        
                        updateHeaderPreview();
                    }
                } else {
                    console.log('No store found, using defaults');
                    storeData = null;
                    // Set default values
                    document.getElementById('storeName').value = '';
                    document.getElementById('storeAddress').value = '';
                    document.getElementById('storePhone').value = '';
                    document.getElementById('storeLogo').value = 'ğŸ';
                    document.getElementById('storeLogoImage').value = '';
                    document.getElementById('bankName').value = '';
                    document.getElementById('bankAccount').value = '';
                    document.getElementById('bankAccountName').value = '';
                    updateStoreLogoPreview();
                }
            } catch (error) {
                console.error('Error loading store settings:', error);
            }
        }

        function updateStoreLogoPreview() {
            const emoji = document.getElementById('storeLogo').value.trim() || 'ğŸ';
            const imageUrl = document.getElementById('storeLogoImage').value.trim();
            const previewEl = document.getElementById('storeLogoPreview');
            
            if (imageUrl) {
                previewEl.innerHTML = `<img src="${imageUrl}" alt="Logo" class="w-full h-full object-cover" onerror="this.outerHTML='<span class=\\'text-5xl\\'>${emoji}</span>'">`;
            } else {
                previewEl.innerHTML = `<span class="text-5xl">${emoji}</span>`;
            }
        }

        async function restoreStoreFromFirebase() {
            if (!db) {
                alert('âŒ Tidak terhubung ke Firebase!');
                return;
            }

            const spinner = document.getElementById('restoreSpinner');
            spinner?.classList.remove('hidden');

            try {
                // Coba load dari main_store dulu
                let doc = await db.collection('stores').doc(STORE_ID).get();
                
                // Jika main_store tidak ada, cari dokumen lain di collection stores
                if (!doc.exists) {
                    console.log('main_store tidak ditemukan, mencari dokumen lain...');
                    const allStores = await db.collection('stores').limit(1).get();
                    
                    if (!allStores.empty) {
                        const existingStore = allStores.docs[0];
                        console.log('Ditemukan store dengan ID:', existingStore.id);
                        
                        // Migrasi data ke main_store
                        const existingData = existingStore.data();
                        await db.collection('stores').doc(STORE_ID).set({
                            ...existingData,
                            id: STORE_ID,
                            migratedFrom: existingStore.id,
                            migratedAt: Date.now()
                        });
                        
                        // Load ulang dari main_store
                        doc = await db.collection('stores').doc(STORE_ID).get();
                        console.log('Data berhasil dimigrasi ke main_store');
                    }
                }
                
                if (doc.exists) {
                    storeData = doc.data();
                    console.log('Store data loaded:', storeData);
                    
                    // Populate form
                    document.getElementById('storeName').value = storeData.name || '';
                    document.getElementById('storeAddress').value = storeData.address || '';
                    document.getElementById('storePhone').value = storeData.phone || '';
                    document.getElementById('storeLogo').value = storeData.logo || 'ğŸ';
                    document.getElementById('storeLogoImage').value = storeData.logoImage || '';
                    document.getElementById('bankName').value = storeData.bankName || '';
                    document.getElementById('bankAccount').value = storeData.bankAccount || '';
                    document.getElementById('bankAccountName').value = storeData.bankAccountName || '';
                    document.getElementById('referenceCode').value = storeData.referenceCode || '';
                    
                    updateStoreLogoPreview();
                    
                    alert('âœ… Data toko berhasil di-restore dari Firebase!');
                } else {
                    alert('âš ï¸ Belum ada data toko di Firebase. Silakan isi dan simpan terlebih dahulu.');
                }
            } catch (error) {
                console.error('Restore error:', error);
                alert('âŒ Gagal restore: ' + error.message);
            } finally {
                spinner?.classList.add('hidden');
            }
        }

        async function saveStoreSettings() {
            if (!currentUser) return;

            // Cek apakah toko sudah ada di Firebase
            try {
                const doc = await db.collection('stores').doc(STORE_ID).get();
                
                if (!doc.exists) {
                    alert('âš ï¸ Toko belum ada di Firebase. Hubungi administrator untuk membuat toko.');
                    return;
                }
            } catch (error) {
                alert('âŒ Gagal mengecek data toko: ' + error.message);
                return;
            }

            showLoading('Menyimpan perubahan...');

            try {
                const updateData = {
                    name: document.getElementById('storeName').value.trim(),
                    address: document.getElementById('storeAddress').value.trim(),
                    phone: document.getElementById('storePhone').value.trim(),
                    logo: document.getElementById('storeLogo').value.trim() || 'ğŸ',
                    logoImage: document.getElementById('storeLogoImage').value.trim(),
                    bankName: document.getElementById('bankName').value,
                    bankAccount: document.getElementById('bankAccount').value.trim(),
                    bankAccountName: document.getElementById('bankAccountName').value.trim(),
                    referenceCode: document.getElementById('referenceCode').value.trim(),
                    updatedAt: Date.now(),
                    updatedBy: currentUser.uid
                };

                // Hanya update, tidak create baru
                await db.collection('stores').doc(STORE_ID).update(updateData);
                storeData = { ...storeData, ...updateData };
                alert('âœ… Pengaturan toko berhasil disimpan!');
            } catch (error) {
                if (error.code === 'not-found') {
                    alert('âš ï¸ Toko tidak ditemukan. Hubungi administrator.');
                } else {
                    alert('âŒ Gagal menyimpan: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }

        // ==================== PRODUCT FUNCTIONS ====================
        function loadProductsForSeller() {
            if (!currentUser) return;

            if (unsubscribeProducts) unsubscribeProducts();

            // Load all products (shared by all admins) - tidak filter by sellerId
            unsubscribeProducts = db.collection('products')
                .onSnapshot(snapshot => {
                    productsCache = snapshot.docs.map(doc => doc.data());
                    // Sort by createdAt in memory
                    productsCache.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    renderProductsSeller();
                }, error => {
                    console.error('Error loading seller products:', error);
                });
        }

        function loadProductsForBuyer() {
            if (unsubscribeProducts) unsubscribeProducts();

            // Load all active products - simplified query without orderBy to avoid index requirement
            unsubscribeProducts = db.collection('products')
                .where('active', '==', true)
                .onSnapshot(snapshot => {
                    productsCache = snapshot.docs.map(doc => doc.data());
                    // Sort by createdAt in memory
                    productsCache.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    renderProductsBuyer();
                }, error => {
                    console.error('Error loading products:', error);
                    // Fallback: load all products without filter
                    db.collection('products').get().then(snapshot => {
                        productsCache = snapshot.docs.map(doc => doc.data()).filter(p => p.active !== false);
                        productsCache.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                        renderProductsBuyer();
                    });
                });
        }

        function getProductImageHTML(product, size = 'md') {
            const sizes = {
                sm: 'w-12 h-12 text-3xl',
                md: 'w-20 h-20 text-5xl',
                lg: 'w-24 h-24 text-6xl'
            };
            
            if (product.image) {
                return `<img src="${product.image}" alt="${product.name}" class="${sizes[size].split(' ').slice(0,2).join(' ')} object-cover rounded-xl mx-auto" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="${sizes[size]} items-center justify-center mx-auto" style="display:none;">${product.emoji || 'ğŸ'}</div>`;
            }
            return `<div class="${sizes[size]} flex items-center justify-center mx-auto">${product.emoji || 'ğŸ'}</div>`;
        }

        function renderProductsSeller() {
            const list = document.getElementById('productsList');
            const noProducts = document.getElementById('noProductsSeller');

            if (productsCache.length === 0) {
                list.classList.add('hidden');
                noProducts.classList.remove('hidden');
                return;
            }

            list.classList.remove('hidden');
            noProducts.classList.add('hidden');

            list.innerHTML = productsCache.map(p => `
                <div class="bg-white rounded-2xl p-4 shadow-md ${!p.active ? 'opacity-50' : ''}">
                    <div class="flex justify-center mb-3">
                        ${p.image ? 
                            `<img src="${p.image}" alt="${p.name}" class="w-24 h-24 object-cover rounded-xl" onerror="this.outerHTML='<div class=\\'text-5xl\\'>${p.emoji || 'ğŸ'}</div>'">` : 
                            `<div class="text-5xl">${p.emoji || 'ğŸ'}</div>`
                        }
                    </div>
                    <h3 class="font-semibold text-gray-800 text-center truncate">${p.name}</h3>
                    <p class="text-green-600 font-bold text-center">${formatRupiah(p.price)}</p>
                    <p class="text-gray-400 text-xs text-center">per ${p.unit} â€¢ Stok: ${p.stock || 0}</p>
                    ${p.description ? `<p class="text-gray-500 text-xs text-center mt-1 truncate">${p.description}</p>` : ''}
                    <span class="block text-center mt-2 text-xs px-2 py-1 rounded-full ${p.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                        ${p.active ? 'âœ… Aktif' : 'â¸ï¸ Nonaktif'}
                    </span>
                    <div class="flex gap-2 mt-3">
                        <button onclick="editProduct('${p.id}')" class="flex-1 bg-blue-100 text-blue-600 py-2 rounded-lg text-sm hover:bg-blue-200">âœï¸ Edit</button>
                        <button onclick="deleteProduct('${p.id}')" class="flex-1 bg-red-100 text-red-600 py-2 rounded-lg text-sm hover:bg-red-200">ğŸ—‘ï¸ Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function renderProductsBuyer() {
            const grid = document.getElementById('fruitsGrid');
            const noProducts = document.getElementById('noProducts');

            if (productsCache.length === 0) {
                grid.classList.add('hidden');
                noProducts.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            noProducts.classList.add('hidden');

            grid.innerHTML = productsCache.map(p => `
                <div class="fruit-card bg-white rounded-2xl p-4 shadow-md transition-all cursor-pointer hover:shadow-xl" onclick="addToCart('${p.id}')">
                    <div class="flex justify-center mb-3">
                        ${p.image ? 
                            `<img src="${p.image}" alt="${p.name}" class="w-24 h-24 object-cover rounded-xl" onerror="this.outerHTML='<div class=\\'text-6xl\\'>${p.emoji || 'ğŸ'}</div>'">` : 
                            `<div class="text-6xl">${p.emoji || 'ğŸ'}</div>`
                        }
                    </div>
                    <h3 class="font-semibold text-gray-800 text-center truncate">${p.name}</h3>
                    <p class="text-green-600 font-bold text-center">${formatRupiah(p.price)}</p>
                    <p class="text-gray-400 text-xs text-center">per ${p.unit}</p>
                    ${p.description ? `<p class="text-gray-500 text-xs text-center mt-1 line-clamp-2">${p.description}</p>` : ''}
                    <button class="w-full mt-3 bg-orange-500 text-white py-2 rounded-xl text-sm font-medium hover:bg-orange-600 transition">
                        + Tambah
                    </button>
                </div>
            `).join('');
        }

        function updateProductPreview() {
            const emoji = document.getElementById('productEmoji').value.trim() || 'ğŸ';
            const imageUrl = document.getElementById('productImage').value.trim();
            const previewEl = document.getElementById('productPreview');
            
            if (imageUrl) {
                previewEl.innerHTML = `<img src="${imageUrl}" alt="Preview" class="w-full h-full object-cover" onerror="this.outerHTML='<span class=\\'text-5xl\\'>${emoji}</span>'">`;
            } else {
                previewEl.innerHTML = `<span class="text-5xl">${emoji}</span>`;
            }
        }

        function openProductModal(productId = null) {
            editingProductId = productId;
            
            if (productId) {
                const product = productsCache.find(p => p.id === productId);
                if (product) {
                    document.getElementById('productModalTitle').textContent = 'Edit Produk';
                    document.getElementById('productEmoji').value = product.emoji || 'ğŸ';
                    document.getElementById('productImage').value = product.image || '';
                    document.getElementById('productName').value = product.name || '';
                    document.getElementById('productPrice').value = product.price || '';
                    document.getElementById('productUnit').value = product.unit || 'kg';
                    document.getElementById('productStock').value = product.stock || 0;
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productActive').checked = product.active !== false;
                    document.getElementById('productId').value = productId;
                }
            } else {
                document.getElementById('productModalTitle').textContent = 'Tambah Produk';
                document.getElementById('productEmoji').value = 'ğŸ';
                document.getElementById('productImage').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productUnit').value = 'kg';
                document.getElementById('productStock').value = '';
                document.getElementById('productDescription').value = '';
                document.getElementById('productActive').checked = true;
                document.getElementById('productId').value = '';
            }

            updateProductPreview();
            document.getElementById('productModal').classList.remove('hidden');
            document.getElementById('productModal').classList.add('flex');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            document.getElementById('productModal').classList.remove('flex');
            editingProductId = null;
        }

        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            const emoji = document.getElementById('productEmoji').value.trim() || 'ğŸ';
            const image = document.getElementById('productImage').value.trim();
            const unit = document.getElementById('productUnit').value;
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            const description = document.getElementById('productDescription').value.trim();
            const active = document.getElementById('productActive').checked;

            if (!name || price <= 0) {
                alert('Nama produk dan harga wajib diisi!');
                return;
            }

            showLoading('Menyimpan produk...');

            try {
                const productData = {
                    name, price, emoji, image, unit, stock, description, active,
                    updatedAt: Date.now()
                };

                if (editingProductId) {
                    await db.collection('products').doc(editingProductId).update(productData);
                } else {
                    const id = 'P' + Date.now().toString(36).toUpperCase();
                    await db.collection('products').doc(id).set({
                        id,
                        storeId: STORE_ID, // Semua produk milik single store
                        createdBy: currentUser.uid,
                        ...productData,
                        createdAt: Date.now()
                    });
                }
                closeProductModal();
            } catch (error) {
                alert('âŒ Gagal menyimpan: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        async function deleteProduct(productId) {
            if (!confirm('Hapus produk ini?')) return;

            showLoading('Menghapus...');
            try {
                await db.collection('products').doc(productId).delete();
            } catch (error) {
                alert('âŒ Gagal menghapus: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Sample products data
        const sampleProducts = [
            { emoji: 'ğŸ', name: 'Apel Fuji Premium', price: 35000, unit: 'kg', stock: 50, description: 'Apel manis dan renyah dari Jepang', image: 'https://images.unsplash.com/photo-1560806887-1e4cd0b6cbd6?w=300' },
            { emoji: 'ğŸŠ', name: 'Jeruk Sunkist', price: 28000, unit: 'kg', stock: 80, description: 'Jeruk manis segar tanpa biji', image: 'https://images.unsplash.com/photo-1547514701-42782101795e?w=300' },
            { emoji: 'ğŸ‡', name: 'Anggur Merah Import', price: 55000, unit: 'kg', stock: 30, description: 'Anggur merah manis dari Chile', image: 'https://images.unsplash.com/photo-1537640538966-79f369143f8f?w=300' },
            { emoji: 'ğŸŒ', name: 'Pisang Cavendish', price: 18000, unit: 'sisir', stock: 100, description: 'Pisang premium kualitas ekspor', image: 'https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?w=300' },
            { emoji: 'ğŸ‰', name: 'Semangka Merah', price: 25000, unit: 'buah', stock: 40, description: 'Semangka manis dan segar', image: 'https://images.unsplash.com/photo-1587049352846-4a222e784d38?w=300' },
            { emoji: 'ğŸ¥­', name: 'Mangga Harum Manis', price: 32000, unit: 'kg', stock: 60, description: 'Mangga lokal super manis', image: 'https://images.unsplash.com/photo-1553279768-865429fa0078?w=300' },
            { emoji: 'ğŸ“', name: 'Strawberry Fresh', price: 45000, unit: 'pack', stock: 25, description: 'Strawberry segar dari Bandung', image: 'https://images.unsplash.com/photo-1464965911861-746a04b4bca6?w=300' },
            { emoji: 'ğŸ‰', name: 'Buah Naga Merah', price: 28000, unit: 'kg', stock: 45, description: 'Buah naga merah organik', image: 'https://images.unsplash.com/photo-1527325678964-54921661f888?w=300' },
            { emoji: 'ğŸ', name: 'Nanas Madu', price: 15000, unit: 'buah', stock: 70, description: 'Nanas manis tanpa serat kasar', image: 'https://images.unsplash.com/photo-1550258987-190a2d41a8ba?w=300' },
            { emoji: 'ğŸ¥', name: 'Kiwi Green', price: 48000, unit: 'pack', stock: 20, description: 'Kiwi hijau segar dari New Zealand', image: 'https://images.unsplash.com/photo-1585059895524-72359e06133a?w=300' },
            { emoji: 'ğŸ', name: 'Pir Xiang Lie', price: 38000, unit: 'kg', stock: 35, description: 'Pir manis dan berair dari China', image: 'https://images.unsplash.com/photo-1514756331096-242fdeb70d4a?w=300' },
            { emoji: 'ğŸ«', name: 'Blueberry Import', price: 65000, unit: 'pack', stock: 15, description: 'Blueberry segar kaya antioksidan', image: 'https://images.unsplash.com/photo-1498557850523-fd3d118b962e?w=300' },
            { emoji: 'ğŸ‹', name: 'Lemon California', price: 35000, unit: 'kg', stock: 40, description: 'Lemon segar untuk minuman & masakan', image: 'https://images.unsplash.com/photo-1590502593747-42a996133562?w=300' },
            { emoji: 'ğŸ¥‘', name: 'Alpukat Mentega', price: 30000, unit: 'kg', stock: 55, description: 'Alpukat lembut untuk smoothie', image: 'https://images.unsplash.com/photo-1523049673857-eb18f1d7b578?w=300' },
            { emoji: 'ğŸˆ', name: 'Melon Hijau', price: 22000, unit: 'buah', stock: 50, description: 'Melon manis dan menyegarkan', image: 'https://images.unsplash.com/photo-1571575173700-afb9492e6a50?w=300' },
            { emoji: 'ğŸ¥¥', name: 'Kelapa Muda', price: 12000, unit: 'buah', stock: 90, description: 'Kelapa muda segar untuk es kelapa', image: 'https://images.unsplash.com/photo-1560769629-975ec94e6a86?w=300' },
            { emoji: 'ğŸ’', name: 'Cherry Import', price: 120000, unit: 'pack', stock: 10, description: 'Cherry merah premium dari USA', image: 'https://images.unsplash.com/photo-1528821128474-27f963b062bf?w=300' },
            { emoji: 'ğŸ‘', name: 'Peach Korea', price: 58000, unit: 'kg', stock: 20, description: 'Buah persik manis dari Korea', image: 'https://images.unsplash.com/photo-1629226182678-73793c267728?w=300' },
            { emoji: 'ğŸ', name: 'Apel Hijau Granny', price: 40000, unit: 'kg', stock: 45, description: 'Apel hijau segar asam manis', image: 'https://images.unsplash.com/photo-1569870499705-504209102861?w=300' },
            { emoji: 'ğŸŠ', name: 'Jeruk Mandarin', price: 45000, unit: 'kg', stock: 35, description: 'Jeruk kecil manis tanpa biji', image: 'https://images.unsplash.com/photo-1611080626919-7cf5a9dbab5b?w=300' }
        ];

        async function addSampleProducts() {
            if (!currentUser) return;

            const confirmAdd = confirm(`Tambahkan ${sampleProducts.length} produk sample buah?\n\nProduk akan ditambahkan ke katalog toko Anda.`);
            if (!confirmAdd) return;

            showLoading('Menambahkan produk sample...');

            try {
                const batch = db.batch();
                let addedCount = 0;

                for (const product of sampleProducts) {
                    const id = 'P' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 5).toUpperCase();
                    const docRef = db.collection('products').doc(id);
                    
                    batch.set(docRef, {
                        id,
                        storeId: STORE_ID,
                        createdBy: currentUser.uid,
                        emoji: product.emoji,
                        name: product.name,
                        price: product.price,
                        unit: product.unit,
                        stock: product.stock,
                        description: product.description,
                        image: product.image || '',
                        active: true,
                        createdAt: Date.now() + addedCount,
                        updatedAt: Date.now()
                    });
                    addedCount++;

                    // Batch commit setiap 10 produk (Firestore limit 500 per batch)
                    if (addedCount % 10 === 0) {
                        await batch.commit();
                    }
                }

                // Commit sisa produk
                await batch.commit();

                alert(`âœ… Berhasil menambahkan ${addedCount} produk sample!\n\nğŸğŸŠğŸ‡ğŸŒğŸ‰ğŸ¥­ğŸ“ğŸğŸ¥ğŸ`);
            } catch (error) {
                console.error('Error adding sample products:', error);
                alert('âŒ Gagal menambahkan produk: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ==================== SELLER TABS ====================
        function switchSellerTab(tab) {
            document.getElementById('ordersTab').classList.toggle('hidden', tab !== 'orders');
            document.getElementById('productsTab').classList.toggle('hidden', tab !== 'products');
            document.getElementById('storeTab').classList.toggle('hidden', tab !== 'store');
            document.getElementById('headerTab').classList.toggle('hidden', tab !== 'header');

            document.getElementById('tabOrders').classList.toggle('tab-active', tab === 'orders');
            document.getElementById('tabProducts').classList.toggle('tab-active', tab === 'products');
            document.getElementById('tabStore').classList.toggle('tab-active', tab === 'store');
            document.getElementById('tabHeader').classList.toggle('tab-active', tab === 'header');

            // Load data when switching tabs
            if (tab === 'store') {
                loadStoreSettings();
            } else if (tab === 'header') {
                loadHeaderSettings();
            }
        }

        // ==================== HEADER SETTINGS ====================
        const bannerColors = {
            green: 'bg-gradient-to-r from-green-500 to-green-600',
            orange: 'bg-gradient-to-r from-orange-500 to-orange-600',
            blue: 'bg-gradient-to-r from-blue-500 to-blue-600',
            purple: 'bg-gradient-to-r from-purple-500 to-purple-600',
            red: 'bg-gradient-to-r from-red-500 to-red-600',
            pink: 'bg-gradient-to-r from-pink-500 to-pink-600',
            teal: 'bg-gradient-to-r from-teal-500 to-teal-600',
            gray: 'bg-gradient-to-r from-gray-700 to-gray-800'
        };

        async function loadHeaderSettings() {
            try {
                // Always reload from Firestore to get latest data
                const doc = await db.collection('stores').doc(STORE_ID).get();
                if (doc.exists) {
                    storeData = doc.data();
                    console.log('Header data loaded:', storeData);
                }
                
                if (!storeData) {
                    // Set defaults if no store data
                    document.getElementById('headerStoreName').value = 'Fruits & Goods';
                    document.getElementById('headerTagline').value = 'Fresh fruits & more';
                    document.getElementById('headerEmoji').value = 'ğŸ›’';
                    document.getElementById('headerLogoUrl').value = '';
                    updateHeaderPreview();
                    return;
                }
                
                document.getElementById('headerStoreName').value = storeData.headerName || storeData.name || 'Fruits & Goods';
                document.getElementById('headerTagline').value = storeData.tagline || 'Fresh fruits & more';
                document.getElementById('headerEmoji').value = storeData.headerEmoji || storeData.logo || 'ğŸ›’';
                document.getElementById('headerLogoUrl').value = storeData.headerLogoUrl || storeData.logoImage || '';
                
                // Set banner color
                const color = storeData.bannerColor || 'green';
                const colorRadio = document.querySelector(`input[name="bannerColor"][value="${color}"]`);
                if (colorRadio) colorRadio.checked = true;
                
                updateHeaderPreview();
            } catch (error) {
                console.error('Error loading header settings:', error);
            }
        }

        function updateHeaderPreview() {
            const storeName = document.getElementById('headerStoreName').value.trim() || 'Fruits & Goods';
            const tagline = document.getElementById('headerTagline').value.trim() || 'Fresh fruits & more';
            const emoji = document.getElementById('headerEmoji').value.trim() || 'ğŸ›’';
            const logoUrl = document.getElementById('headerLogoUrl').value.trim();
            const color = document.querySelector('input[name="bannerColor"]:checked')?.value || 'green';

            // Update preview
            document.getElementById('previewStoreName').textContent = storeName;
            document.getElementById('previewTagline').textContent = tagline;
            
            const previewBanner = document.getElementById('previewBanner');
            previewBanner.className = `${bannerColors[color]} text-white py-4 px-4`;
            
            const previewLogo = document.getElementById('previewLogo');
            if (logoUrl) {
                previewLogo.innerHTML = `<img src="${logoUrl}" alt="Logo" class="w-full h-full object-cover" onerror="this.outerHTML='${emoji}'">`;
            } else {
                previewLogo.textContent = emoji;
            }
        }

        async function restoreHeaderFromFirebase() {
            if (!db) {
                alert('âŒ Tidak terhubung ke Firebase!');
                return;
            }

            showLoading('Memuat data header...');

            try {
                const doc = await db.collection('stores').doc(STORE_ID).get();
                if (doc.exists) {
                    storeData = doc.data();
                    
                    document.getElementById('headerStoreName').value = storeData.headerName || storeData.name || 'Fruits & Goods';
                    document.getElementById('headerTagline').value = storeData.tagline || 'Fresh fruits & more';
                    document.getElementById('headerEmoji').value = storeData.headerEmoji || storeData.logo || 'ğŸ›’';
                    document.getElementById('headerLogoUrl').value = storeData.headerLogoUrl || storeData.logoImage || '';
                    
                    // Set banner color
                    const color = storeData.bannerColor || 'green';
                    const colorRadio = document.querySelector(`input[name="bannerColor"][value="${color}"]`);
                    if (colorRadio) colorRadio.checked = true;
                    
                    updateHeaderPreview();
                    
                    alert('âœ… Data header berhasil di-restore dari Firebase!');
                } else {
                    alert('âš ï¸ Belum ada data toko di Firebase.');
                }
            } catch (error) {
                alert('âŒ Gagal restore: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function saveHeaderSettings() {
            if (!currentUser) return;

            // Cek apakah toko sudah ada
            try {
                const doc = await db.collection('stores').doc(STORE_ID).get();
                if (!doc.exists) {
                    alert('âš ï¸ Toko belum ada di Firebase. Hubungi administrator untuk membuat toko.');
                    return;
                }
            } catch (error) {
                alert('âŒ Gagal mengecek data toko: ' + error.message);
                return;
            }

            const headerName = document.getElementById('headerStoreName').value.trim() || 'Fruits & Goods';
            const tagline = document.getElementById('headerTagline').value.trim() || 'Fresh fruits & more';
            const headerEmoji = document.getElementById('headerEmoji').value.trim() || 'ğŸ›’';
            const headerLogoUrl = document.getElementById('headerLogoUrl').value.trim();
            const bannerColor = document.querySelector('input[name="bannerColor"]:checked')?.value || 'green';

            showLoading('Menyimpan header...');

            try {
                // Hanya update, tidak create baru
                await db.collection('stores').doc(STORE_ID).update({
                    headerName,
                    tagline,
                    headerEmoji,
                    headerLogoUrl,
                    bannerColor,
                    updatedAt: Date.now(),
                    updatedBy: currentUser.uid
                });

                storeData = { 
                    ...storeData, 
                    headerName, 
                    tagline, 
                    headerEmoji, 
                    headerLogoUrl, 
                    bannerColor 
                };

                alert('âœ… Header berhasil disimpan!');
            } catch (error) {
                if (error.code === 'not-found') {
                    alert('âš ï¸ Toko tidak ditemukan. Hubungi administrator.');
                } else {
                    alert('âŒ Gagal menyimpan: ' + error.message);
                }
            } finally {
                hideLoading();
            }
        }

        // ==================== CART FUNCTIONS ====================
        function addToCart(productId) {
            const product = productsCache.find(p => p.id === productId);
            if (!product) return;

            const existing = cart.find(item => item.id === productId);
            
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ ...product, qty: 1 });
            }
            
            renderCart();
            
            const countEl = document.getElementById('cartCount');
            countEl.classList.add('cart-bounce');
            setTimeout(() => countEl.classList.remove('cart-bounce'), 300);
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
        }

        function updateQty(productId, delta) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.qty += delta;
                if (item.qty <= 0) {
                    removeFromCart(productId);
                } else {
                    renderCart();
                }
            }
        }

        function renderCart() {
            const cartItemsEl = document.getElementById('cartItems');
            const cartCountEl = document.getElementById('cartCount');
            const cartTotalEl = document.getElementById('cartTotal');
            const checkoutBtn = document.getElementById('checkoutBtn');

            const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);

            cartCountEl.textContent = totalItems;
            cartTotalEl.textContent = formatRupiah(totalPrice);
            checkoutBtn.disabled = cart.length === 0;

            if (cart.length === 0) {
                cartItemsEl.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <span class="text-4xl block mb-2">ğŸ›’</span>
                        <p>Keranjang kosong</p>
                    </div>
                `;
            } else {
                cartItemsEl.innerHTML = cart.map(item => `
                    <div class="bg-gray-50 rounded-xl p-3 flex items-center gap-3">
                        ${item.image ? 
                            `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg" onerror="this.outerHTML='<span class=\\'text-3xl\\'>${item.emoji || 'ğŸ'}</span>'">` : 
                            `<span class="text-3xl">${item.emoji || 'ğŸ'}</span>`
                        }
                        <div class="flex-1 min-w-0">
                            <h4 class="font-medium text-gray-800 truncate">${item.name}</h4>
                            <p class="text-green-600 text-sm font-semibold">${formatRupiah(item.price * item.qty)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateQty('${item.id}', -1)" class="w-7 h-7 bg-gray-200 rounded-full hover:bg-gray-300 font-bold">-</button>
                            <span class="w-6 text-center font-medium">${item.qty}</span>
                            <button onclick="updateQty('${item.id}', 1)" class="w-7 h-7 bg-orange-500 text-white rounded-full hover:bg-orange-600 font-bold">+</button>
                        </div>
                        <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700 text-xl">Ã—</button>
                    </div>
                `).join('');
            }
        }

        function toggleCart() {
            document.getElementById('cartSidebar').classList.toggle('translate-x-full');
            document.getElementById('cartOverlay').classList.toggle('hidden');
        }

        function toggleMyOrders() {
            document.getElementById('myOrdersSidebar').classList.toggle('translate-x-full');
            document.getElementById('myOrdersOverlay').classList.toggle('hidden');
        }

        // ==================== ORDER FUNCTIONS ====================
        async function checkout() {
            if (cart.length === 0 || !currentUser) return;

            const orderId = 'ORD' + Date.now().toString(36).toUpperCase();
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            const order = {
                id: orderId,
                buyerId: currentUser.uid,
                buyerName: currentUserData?.name || 'Pembeli',
                buyerPhone: currentUserData?.phone || '',
                buyerAddress: currentUserData?.address || '',
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    emoji: item.emoji || 'ğŸ',
                    image: item.image || '',
                    price: item.price,
                    qty: item.qty
                })),
                subtotal: subtotal,
                grandTotal: subtotal,
                status: 'pending',
                createdAt: Date.now()
            };

            showLoading('Mengirim pesanan...');

            try {
                await db.collection('orders').doc(orderId).set(order);
                
                document.getElementById('orderIdDisplay').textContent = orderId;
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('successModal').classList.add('flex');

                cart = [];
                renderCart();
                toggleCart();
            } catch (error) {
                alert('âŒ Gagal mengirim pesanan: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        function loadOrdersForSeller() {
            if (unsubscribeOrders) unsubscribeOrders();

            // Load all orders for seller
            unsubscribeOrders = db.collection('orders')
                .onSnapshot(snapshot => {
                    ordersCache = snapshot.docs.map(doc => doc.data());
                    // Sort by createdAt in memory
                    ordersCache.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    renderOrdersSeller();
                }, error => {
                    console.error('Error loading orders:', error);
                });
        }

        function loadOrdersForBuyer() {
            if (!currentUser) return;

            if (unsubscribeOrders) unsubscribeOrders();

            // Simplified query without orderBy to avoid index requirement
            unsubscribeOrders = db.collection('orders')
                .where('buyerId', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    ordersCache = snapshot.docs.map(doc => doc.data());
                    // Sort by createdAt in memory
                    ordersCache.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                    renderOrdersBuyer();
                    checkPendingConfirmations();
                }, error => {
                    console.error('Error loading orders:', error);
                });
        }

        function checkPendingConfirmations() {
            const waitingOrders = ordersCache.filter(o => o.status === 'waiting_buyer');
            document.getElementById('actionBanner').classList.toggle('hidden', waitingOrders.length === 0);
        }

        function renderOrdersSeller() {
            const ordersList = document.getElementById('ordersList');
            const noOrders = document.getElementById('noOrders');

            document.getElementById('statOrders').textContent = ordersCache.length;
            document.getElementById('statPending').textContent = ordersCache.filter(o => o.status === 'pending').length;
            document.getElementById('statPayment').textContent = ordersCache.filter(o => o.status === 'waiting_payment').length;
            document.getElementById('statProcessing').textContent = ordersCache.filter(o => ['processing', 'shipped'].includes(o.status)).length;
            document.getElementById('statCompleted').textContent = ordersCache.filter(o => o.status === 'completed').length;
            document.getElementById('statCancelled').textContent = ordersCache.filter(o => o.status === 'cancelled').length;

            if (ordersCache.length === 0) {
                ordersList.classList.add('hidden');
                noOrders.classList.remove('hidden');
                return;
            }

            ordersList.classList.remove('hidden');
            noOrders.classList.add('hidden');

            const statusLabels = {
                pending: 'â³ Pending',
                waiting_buyer: 'ğŸ”” Menunggu Pembeli',
                waiting_payment: 'ğŸ’° Menunggu Pembayaran',
                processing: 'ğŸ”„ Diproses',
                shipped: 'ğŸšš Dikirim',
                completed: 'âœ… Selesai',
                cancelled: 'âŒ Dibatalkan'
            };

            ordersList.innerHTML = ordersCache.map(order => {
                const date = new Date(order.createdAt);
                const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="p-4 hover:bg-gray-50 ${order.status === 'waiting_payment' ? 'bg-amber-50 payment-glow' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">${order.id}</span>
                            <span class="text-xs text-gray-400">${dateStr}</span>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-3 mb-3">
                            <p class="font-medium text-gray-800">${order.buyerName}</p>
                            <p class="text-xs text-gray-600">ğŸ“ ${order.buyerPhone}</p>
                            <p class="text-xs text-gray-600">ğŸ“ ${order.buyerAddress}</p>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            ${order.items.map(item => `
                                <span class="bg-orange-50 text-orange-700 px-2 py-1 rounded-lg text-sm">
                                    ${item.emoji} ${item.name} x${item.qty}
                                </span>
                            `).join('')}
                        </div>

                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-green-600">${formatRupiah(order.grandTotal)}</span>
                            <span class="text-xs px-2 py-1 rounded-full bg-gray-100">${statusLabels[order.status]}</span>
                        </div>

                        <div class="flex flex-wrap gap-2">
                            ${order.status === 'pending' ? `
                                <button onclick="openShippingModal('${order.id}')" class="bg-purple-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-purple-600">
                                    ğŸšš Tambah Ongkir
                                </button>
                            ` : ''}
                            ${order.status === 'waiting_payment' ? `
                                <button onclick="openPaymentModal('${order.id}')" class="bg-amber-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-amber-600">
                                    ğŸ’° Konfirmasi Bayar
                                </button>
                            ` : ''}
                            ${order.status === 'processing' ? `
                                <button onclick="openShippingConfirmModal('${order.id}')" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600">
                                    ğŸšš Konfirmasi Kirim
                                </button>
                            ` : ''}
                            ${order.status === 'shipped' ? `
                                <button onclick="completeOrder('${order.id}')" class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-600">
                                    âœ… Selesai
                                </button>
                            ` : ''}
                            <button onclick="chatWithBuyer('${order.id}')" class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                Chat
                            </button>
                            <button onclick="deleteOrder('${order.id}')" class="bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm hover:bg-red-200">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderOrdersBuyer() {
            const listEl = document.getElementById('myOrdersList');

            if (ordersCache.length === 0) {
                listEl.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <span class="text-4xl block mb-2">ğŸ“‹</span>
                        <p>Belum ada pesanan</p>
                    </div>
                `;
                return;
            }

            const statusLabels = {
                pending: 'â³ Menunggu Penjual',
                waiting_buyer: 'ğŸ”” Perlu Konfirmasi',
                waiting_payment: 'ğŸ’³ Menunggu Pembayaran',
                processing: 'ğŸ”„ Sedang Diproses',
                shipped: 'ğŸšš Sedang Dikirim',
                completed: 'âœ… Selesai',
                cancelled: 'âŒ Dibatalkan'
            };

            listEl.innerHTML = ordersCache.map(order => {
                const needsAction = order.status === 'waiting_buyer';

                return `
                    <div class="bg-gray-50 rounded-xl p-4 ${needsAction ? 'ring-2 ring-orange-500 blink' : ''}">
                        <div class="flex justify-between items-start mb-3">
                            <span class="font-mono text-sm bg-white px-2 py-1 rounded shadow-sm">${order.id}</span>
                            <span class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700">${statusLabels[order.status]}</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${order.items.map(item => `
                                <span class="bg-white text-gray-700 px-2 py-1 rounded text-xs shadow-sm">
                                    ${item.emoji} ${item.name} x${item.qty}
                                </span>
                            `).join('')}
                        </div>

                        <div class="bg-white rounded-lg p-3 mb-3">
                            <div class="flex justify-between text-sm">
                                <span>Subtotal:</span>
                                <span>${formatRupiah(order.subtotal)}</span>
                            </div>
                            ${order.shippingCost ? `
                                <div class="flex justify-between text-sm text-orange-600">
                                    <span>Ongkir:</span>
                                    <span>${formatRupiah(order.shippingCost)}</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between font-bold text-green-600 border-t pt-2 mt-2">
                                <span>Total:</span>
                                <span>${formatRupiah(order.grandTotal)}</span>
                            </div>
                        </div>

                        ${needsAction ? `
                            <div class="flex gap-2">
                                <button onclick="openBuyerConfirmModal('${order.id}')" class="flex-1 bg-green-500 text-white py-2 rounded-lg font-semibold hover:bg-green-600 text-sm">
                                    ğŸ’³ Lanjutkan
                                </button>
                                <button onclick="cancelOrder('${order.id}')" class="flex-1 bg-red-500 text-white py-2 rounded-lg font-semibold hover:bg-red-600 text-sm">
                                    âŒ Batal
                                </button>
                            </div>
                        ` : ''}

                        ${order.status === 'waiting_payment' && storeData ? `
                            <div class="bg-amber-50 rounded-lg p-3">
                                <p class="text-xs text-amber-700 font-medium">ğŸ’³ Transfer ke:</p>
                                <p class="text-sm text-amber-800">${storeData.bankName}: ${storeData.bankAccount}</p>
                                <p class="text-sm text-amber-800">a.n. ${storeData.bankAccountName}</p>
                            </div>
                        ` : ''}

                        ${order.trackingNumber ? `
                            <div class="bg-blue-50 rounded-lg p-3 mt-3">
                                <p class="text-xs text-blue-600 font-medium">ğŸšš No. Resi:</p>
                                <p class="text-sm text-blue-800 font-mono">${order.trackingNumber}</p>
                            </div>
                        ` : ''}

                        <button onclick="chatWithSeller('${order.id}')" class="w-full mt-3 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 flex items-center justify-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Chat Penjual
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ==================== MODALS ====================
        function openShippingModal(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;
            currentOrderForShipping = order;

            document.getElementById('shippingOrderInfo').innerHTML = `
                <div class="font-mono text-sm mb-2">${order.id}</div>
                <div class="flex flex-wrap gap-1">
                    ${order.items.map(item => `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">${item.emoji} ${item.name} x${item.qty}</span>`).join('')}
                </div>
            `;

            document.getElementById('shippingBuyerInfo').innerHTML = `
                <p class="text-xs text-blue-600 font-medium mb-1">ğŸ‘¤ Pembeli:</p>
                <p class="text-sm font-medium">${order.buyerName}</p>
                <p class="text-xs text-gray-600">ğŸ“ ${order.buyerPhone}</p>
                <p class="text-xs text-gray-600">ğŸ“ ${order.buyerAddress}</p>
            `;

            document.getElementById('modalSubtotal').textContent = formatRupiah(order.subtotal);
            document.getElementById('modalShipping').textContent = 'Rp 0';
            document.getElementById('modalTotal').textContent = formatRupiah(order.subtotal);
            document.getElementById('shippingCostInput').value = '';
            document.getElementById('sellerNoteInput').value = '';

            document.getElementById('shippingModal').classList.remove('hidden');
            document.getElementById('shippingModal').classList.add('flex');
        }

        function closeShippingModal() {
            document.getElementById('shippingModal').classList.add('hidden');
            document.getElementById('shippingModal').classList.remove('flex');
        }

        document.getElementById('shippingCostInput')?.addEventListener('input', (e) => {
            if (currentOrderForShipping) {
                const shipping = parseInt(e.target.value) || 0;
                document.getElementById('modalShipping').textContent = formatRupiah(shipping);
                document.getElementById('modalTotal').textContent = formatRupiah(currentOrderForShipping.subtotal + shipping);
            }
        });

        async function confirmOrderWithShipping() {
            if (!currentOrderForShipping) return;

            const shippingCost = parseInt(document.getElementById('shippingCostInput').value) || 0;
            const sellerNote = document.getElementById('sellerNoteInput').value.trim();

            showLoading('Mengirim ke pembeli...');

            try {
                await db.collection('orders').doc(currentOrderForShipping.id).update({
                    shippingCost,
                    grandTotal: currentOrderForShipping.subtotal + shippingCost,
                    sellerNote,
                    status: 'waiting_buyer',
                    updatedAt: Date.now()
                });
                closeShippingModal();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function openBuyerConfirmModal(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;
            currentOrderForConfirm = order;

            document.getElementById('confirmOrderInfo').innerHTML = `
                <div class="flex flex-wrap gap-1">
                    ${order.items.map(item => `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">${item.emoji} ${item.name} x${item.qty}</span>`).join('')}
                </div>
            `;

            document.getElementById('confirmSubtotal').textContent = formatRupiah(order.subtotal);
            document.getElementById('confirmShipping').textContent = formatRupiah(order.shippingCost || 0);
            document.getElementById('confirmTotal').textContent = formatRupiah(order.grandTotal);

            if (order.sellerNote) {
                document.getElementById('confirmSellerNote').classList.remove('hidden');
                document.getElementById('confirmNoteText').textContent = order.sellerNote;
            } else {
                document.getElementById('confirmSellerNote').classList.add('hidden');
            }

            if (storeData && storeData.bankAccount) {
                document.getElementById('confirmBankDetails').textContent = `${storeData.bankName}: ${storeData.bankAccount} a.n. ${storeData.bankAccountName}`;
            }

            document.getElementById('buyerConfirmModal').classList.remove('hidden');
            document.getElementById('buyerConfirmModal').classList.add('flex');
        }

        function closeBuyerConfirmModal() {
            document.getElementById('buyerConfirmModal').classList.add('hidden');
            document.getElementById('buyerConfirmModal').classList.remove('flex');
        }

        async function confirmOrderByBuyer() {
            if (!currentOrderForConfirm) return;

            showLoading('Mengkonfirmasi...');

            try {
                await db.collection('orders').doc(currentOrderForConfirm.id).update({
                    status: 'waiting_payment',
                    buyerConfirmedAt: Date.now()
                });
                closeBuyerConfirmModal();
                alert('âœ… Pesanan dikonfirmasi!\n\nSilakan transfer ke rekening penjual.\nPesanan akan diproses setelah pembayaran dikonfirmasi.');
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function cancelOrder(orderId) {
            if (!confirm('Batalkan pesanan ini?')) return;

            showLoading('Membatalkan...');

            try {
                await db.collection('orders').doc(orderId).update({
                    status: 'cancelled',
                    cancelledBy: 'buyer',
                    cancelledAt: Date.now()
                });
                closeBuyerConfirmModal();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function cancelOrderByBuyer() {
            if (currentOrderForConfirm) {
                await cancelOrder(currentOrderForConfirm.id);
            }
        }

        function openPaymentModal(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;
            currentOrderForPayment = order;

            document.getElementById('paymentOrderInfo').innerHTML = `
                <p class="font-mono text-sm mb-2">${order.id}</p>
                <p class="text-sm">Pembeli: <strong>${order.buyerName}</strong></p>
            `;
            document.getElementById('paymentTotal').textContent = formatRupiah(order.grandTotal);

            document.getElementById('paymentModal').classList.remove('hidden');
            document.getElementById('paymentModal').classList.add('flex');
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentModal').classList.remove('flex');
        }

        async function confirmPaymentReceived() {
            if (!currentOrderForPayment) return;

            showLoading('Mengkonfirmasi...');

            try {
                await db.collection('orders').doc(currentOrderForPayment.id).update({
                    status: 'processing',
                    paymentConfirmedAt: Date.now()
                });
                closePaymentModal();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function openShippingConfirmModal(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;
            currentOrderForShippingConfirm = order;

            document.getElementById('shippingConfirmOrderInfo').innerHTML = `
                <p class="font-mono text-sm mb-2">${order.id}</p>
                <p class="text-sm">Pembeli: <strong>${order.buyerName}</strong></p>
                <p class="text-xs text-gray-500">ğŸ“ ${order.buyerAddress}</p>
            `;

            document.getElementById('shippingConfirmModal').classList.remove('hidden');
            document.getElementById('shippingConfirmModal').classList.add('flex');
        }

        function closeShippingConfirmModal() {
            document.getElementById('shippingConfirmModal').classList.add('hidden');
            document.getElementById('shippingConfirmModal').classList.remove('flex');
        }

        async function confirmShipping() {
            if (!currentOrderForShippingConfirm) return;

            const courier = document.getElementById('courierSelect').options[document.getElementById('courierSelect').selectedIndex].text;
            const trackingNumber = document.getElementById('trackingNumberInput').value.trim();

            showLoading('Mengkonfirmasi pengiriman...');

            try {
                await db.collection('orders').doc(currentOrderForShippingConfirm.id).update({
                    status: 'shipped',
                    courier,
                    trackingNumber,
                    shippedAt: Date.now()
                });
                closeShippingConfirmModal();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function completeOrder(orderId) {
            showLoading('Menyelesaikan...');
            try {
                await db.collection('orders').doc(orderId).update({
                    status: 'completed',
                    completedAt: Date.now()
                });
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Hapus order ini?')) return;

            showLoading('Menghapus...');
            try {
                await db.collection('orders').doc(orderId).delete();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function clearAllOrders() {
            if (!confirm('Hapus semua order?')) return;

            showLoading('Menghapus semua...');
            try {
                const batch = db.batch();
                ordersCache.forEach(order => {
                    batch.delete(db.collection('orders').doc(order.id));
                });
                await batch.commit();
            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ==================== WHATSAPP FUNCTIONS ====================
        function formatPhoneForWA(phone) {
            if (!phone) return '';
            let cleaned = phone.replace(/\D/g, '');
            if (cleaned.startsWith('0')) {
                cleaned = '62' + cleaned.substring(1);
            } else if (!cleaned.startsWith('62')) {
                cleaned = '62' + cleaned;
            }
            return cleaned;
        }

        function openWhatsApp(phone, message) {
            const waPhone = formatPhoneForWA(phone);
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${waPhone}?text=${encodedMessage}`, '_blank');
        }

        // Penjual kirim ongkir ke pembeli + WA
        async function confirmOrderWithShippingAndWA() {
            if (!currentOrderForShipping) return;

            const shippingCost = parseInt(document.getElementById('shippingCostInput').value) || 0;
            const sellerNote = document.getElementById('sellerNoteInput').value.trim();
            const grandTotal = currentOrderForShipping.subtotal + shippingCost;

            showLoading('Mengirim ke pembeli...');

            try {
                await db.collection('orders').doc(currentOrderForShipping.id).update({
                    shippingCost,
                    grandTotal,
                    sellerNote,
                    status: 'waiting_buyer',
                    updatedAt: Date.now()
                });
                closeShippingModal();

                // Buat pesan WA
                const itemsList = currentOrderForShipping.items.map(item => `â€¢ ${item.name} x${item.qty} = ${formatRupiah(item.price * item.qty)}`).join('\n');
                const storeName = storeData?.name || 'Fruits & Goods';
                
                const waMessage = `Halo *${currentOrderForShipping.buyerName}* ğŸ‘‹

Pesanan Anda di *${storeName}* telah dikonfirmasi! âœ…

ğŸ“‹ *ID Pesanan:* ${currentOrderForShipping.id}

ğŸ›’ *Detail Pesanan:*
${itemsList}

ğŸ’° *Subtotal:* ${formatRupiah(currentOrderForShipping.subtotal)}
ğŸšš *Ongkos Kirim:* ${formatRupiah(shippingCost)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’µ *TOTAL BAYAR:* ${formatRupiah(grandTotal)}

${sellerNote ? `ğŸ“ *Catatan:* ${sellerNote}\n` : ''}
ğŸ’³ *Transfer ke:*
ğŸ¦ ${storeData?.bankName || 'Bank'}: ${storeData?.bankAccount || '-'}
ğŸ‘¤ a.n. ${storeData?.bankAccountName || '-'}

Mohon segera lakukan pembayaran dan konfirmasi. Terima kasih! ğŸ™`;

                openWhatsApp(currentOrderForShipping.buyerPhone, waMessage);

            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Pembeli konfirmasi pesanan + WA ke penjual
        async function confirmOrderByBuyerAndWA() {
            if (!currentOrderForConfirm) return;

            showLoading('Mengkonfirmasi...');

            try {
                await db.collection('orders').doc(currentOrderForConfirm.id).update({
                    status: 'waiting_payment',
                    buyerConfirmedAt: Date.now()
                });
                closeBuyerConfirmModal();

                // Buat pesan WA ke penjual
                const itemsList = currentOrderForConfirm.items.map(item => `â€¢ ${item.name} x${item.qty}`).join('\n');
                const buyerName = currentUserData?.name || 'Pembeli';
                const buyerPhone = currentUserData?.phone || '';
                const buyerAddress = currentUserData?.address || '';
                
                const waMessage = `Halo Admin *${storeData?.name || 'Fruits & Goods'}* ğŸ‘‹

Saya *${buyerName}* ingin melanjutkan pesanan:

ğŸ“‹ *ID Pesanan:* ${currentOrderForConfirm.id}

ğŸ›’ *Pesanan:*
${itemsList}

ğŸ’µ *Total Bayar:* ${formatRupiah(currentOrderForConfirm.grandTotal)}

ğŸ“± *No. HP:* ${buyerPhone}
ğŸ“ *Alamat:* ${buyerAddress}

Saya akan segera transfer. Mohon konfirmasi setelah pembayaran diterima. Terima kasih! ğŸ™`;

                openWhatsApp(storeData?.phone, waMessage);

                alert('âœ… Pesanan dikonfirmasi!\n\nSilakan transfer ke rekening penjual.');

            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Penjual konfirmasi pembayaran + WA ke pembeli
        async function confirmPaymentReceivedAndWA() {
            if (!currentOrderForPayment) return;

            showLoading('Mengkonfirmasi...');

            try {
                await db.collection('orders').doc(currentOrderForPayment.id).update({
                    status: 'processing',
                    paymentConfirmedAt: Date.now()
                });
                closePaymentModal();

                // Buat pesan WA
                const storeName = storeData?.name || 'Fruits & Goods';
                
                const waMessage = `Halo *${currentOrderForPayment.buyerName}* ğŸ‘‹

Pembayaran pesanan Anda telah kami terima! âœ…ğŸ’°

ğŸ“‹ *ID Pesanan:* ${currentOrderForPayment.id}
ğŸ’µ *Total:* ${formatRupiah(currentOrderForPayment.grandTotal)}

ğŸ”„ Status: *SEDANG DIPROSES*

Pesanan Anda sedang kami siapkan dan akan segera dikirim. ğŸ“¦

Terima kasih telah berbelanja di *${storeName}*! ğŸ™`;

                openWhatsApp(currentOrderForPayment.buyerPhone, waMessage);

            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Penjual konfirmasi pengiriman + WA ke pembeli
        async function confirmShippingAndWA() {
            if (!currentOrderForShippingConfirm) return;

            const courier = document.getElementById('courierSelect').options[document.getElementById('courierSelect').selectedIndex].text;
            const trackingNumber = document.getElementById('trackingNumberInput').value.trim();

            showLoading('Mengkonfirmasi pengiriman...');

            try {
                await db.collection('orders').doc(currentOrderForShippingConfirm.id).update({
                    status: 'shipped',
                    courier,
                    trackingNumber,
                    shippedAt: Date.now()
                });
                closeShippingConfirmModal();

                // Buat pesan WA
                const storeName = storeData?.name || 'Fruits & Goods';
                
                const waMessage = `Halo *${currentOrderForShippingConfirm.buyerName}* ğŸ‘‹

Pesanan Anda sudah dikirim! ğŸššâœ¨

ğŸ“‹ *ID Pesanan:* ${currentOrderForShippingConfirm.id}

ğŸšš *Kurir:* ${courier}
${trackingNumber ? `ğŸ“¦ *No. Resi:* ${trackingNumber}` : ''}

ğŸ“ *Alamat Pengiriman:*
${currentOrderForShippingConfirm.buyerAddress}

Mohon tunggu pesanan Anda sampai. Jika ada pertanyaan, silakan hubungi kami.

Terima kasih telah berbelanja di *${storeName}*! ğŸ™`;

                openWhatsApp(currentOrderForShippingConfirm.buyerPhone, waMessage);

            } catch (error) {
                alert('âŒ Gagal: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ==================== CHAT FUNCTIONS ====================
        // Penjual chat ke Pembeli
        function chatWithBuyer(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            const storeName = storeData?.name || 'Fruits & Goods';
            const itemsList = order.items.map(item => `â€¢ ${item.name} x${item.qty}`).join('\n');
            
            const statusLabels = {
                pending: 'Menunggu konfirmasi ongkir',
                waiting_buyer: 'Menunggu konfirmasi Anda',
                waiting_payment: 'Menunggu pembayaran',
                processing: 'Sedang diproses',
                shipped: 'Sedang dikirim',
                completed: 'Selesai',
                cancelled: 'Dibatalkan'
            };

            const waMessage = `Halo *${order.buyerName}* ğŸ‘‹

Ini dari *${storeName}*.

Mengenai pesanan Anda:
ğŸ“‹ *ID:* ${order.id}
ğŸ“¦ *Status:* ${statusLabels[order.status] || order.status}

ğŸ›’ *Pesanan:*
${itemsList}

ğŸ’µ *Total:* ${formatRupiah(order.grandTotal)}

Ada yang bisa kami bantu? ğŸ˜Š`;

            openWhatsApp(order.buyerPhone, waMessage);
        }

        // Pembeli chat ke Penjual
        function chatWithSeller(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            const storeName = storeData?.name || 'Fruits & Goods';
            const buyerName = currentUserData?.name || 'Pembeli';
            const itemsList = order.items.map(item => `â€¢ ${item.name} x${item.qty}`).join('\n');
            
            const statusLabels = {
                pending: 'Menunggu konfirmasi ongkir',
                waiting_buyer: 'Menunggu konfirmasi saya',
                waiting_payment: 'Menunggu pembayaran',
                processing: 'Sedang diproses',
                shipped: 'Sedang dikirim',
                completed: 'Selesai',
                cancelled: 'Dibatalkan'
            };

            const waMessage = `Halo Admin *${storeName}* ğŸ‘‹

Saya *${buyerName}* ingin bertanya tentang pesanan:

ğŸ“‹ *ID Pesanan:* ${order.id}
ğŸ“¦ *Status:* ${statusLabels[order.status] || order.status}

ğŸ›’ *Pesanan:*
${itemsList}

ğŸ’µ *Total:* ${formatRupiah(order.grandTotal)}

`;

            openWhatsApp(storeData?.phone, waMessage);
        }

        // ==================== CHANGE PASSWORD ====================
        function openChangePasswordModal() {
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('changePasswordError').classList.add('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
            
            document.getElementById('changePasswordModal').classList.remove('hidden');
            document.getElementById('changePasswordModal').classList.add('flex');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.remove('flex');
        }

        function showChangePasswordError(message) {
            const errorEl = document.getElementById('changePasswordError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            document.getElementById('changePasswordSuccess').classList.add('hidden');
        }

        function showChangePasswordSuccess(message) {
            const successEl = document.getElementById('changePasswordSuccess');
            successEl.textContent = message;
            successEl.classList.remove('hidden');
            document.getElementById('changePasswordError').classList.add('hidden');
        }

        async function handleChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            // Validasi
            if (!oldPassword || !newPassword || !confirmNewPassword) {
                showChangePasswordError('Semua field wajib diisi!');
                return;
            }

            if (newPassword.length < 6) {
                showChangePasswordError('Password baru minimal 6 karakter!');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showChangePasswordError('Password baru dan konfirmasi tidak cocok!');
                return;
            }

            if (oldPassword === newPassword) {
                showChangePasswordError('Password baru harus berbeda dengan password lama!');
                return;
            }

            showLoading('Mengubah password...');

            try {
                const user = auth.currentUser;
                
                if (!user || !user.email) {
                    showChangePasswordError('User tidak ditemukan. Silakan login ulang.');
                    hideLoading();
                    return;
                }

                // Re-authenticate user dengan password lama
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);
                await user.reauthenticateWithCredential(credential);

                // Update password
                await user.updatePassword(newPassword);

                showChangePasswordSuccess('âœ… Password berhasil diubah!');
                
                // Clear form
                document.getElementById('oldPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';

                // Tutup modal setelah 2 detik
                setTimeout(() => {
                    closeChangePasswordModal();
                }, 2000);

            } catch (error) {
                console.error('Change password error:', error);
                
                let message = 'Gagal mengubah password. ';
                if (error.code === 'auth/wrong-password') {
                    message = 'Password lama salah!';
                } else if (error.code === 'auth/weak-password') {
                    message = 'Password baru terlalu lemah. Minimal 6 karakter.';
                } else if (error.code === 'auth/requires-recent-login') {
                    message = 'Sesi login sudah lama. Silakan logout dan login kembali.';
                } else if (error.code === 'auth/network-request-failed') {
                    message = 'Gagal terhubung ke server. Periksa koneksi internet.';
                } else {
                    message += error.message;
                }
                
                showChangePasswordError(message);
            } finally {
                hideLoading();
            }
        }

        // ==================== FLOATING CHAT ====================
        function toggleChatListBuyer() {
            const list = document.getElementById('chatListBuyer');
            list.classList.toggle('hidden');
            if (!list.classList.contains('hidden')) {
                renderChatListBuyer();
            }
        }

        function toggleChatListSeller() {
            const list = document.getElementById('chatListSeller');
            list.classList.toggle('hidden');
            if (!list.classList.contains('hidden')) {
                renderChatListSeller();
            }
        }

        function renderChatListBuyer() {
            const container = document.getElementById('chatOrderListBuyer');
            
            if (ordersCache.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-400">
                        <span class="text-3xl block mb-2">ğŸ“­</span>
                        <p class="text-sm">Belum ada pesanan</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = ordersCache.map(order => {
                const time = new Date(order.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const statusLabels = {
                    pending: 'Menunggu konfirmasi...',
                    waiting_buyer: 'Perlu konfirmasi Anda',
                    waiting_payment: 'Menunggu pembayaran',
                    processing: 'Pesanan diproses',
                    shipped: 'Pesanan dikirim',
                    completed: 'Pesanan selesai',
                    cancelled: 'Dibatalkan'
                };
                
                return `
                    <div onclick="openChatFromFloating('${order.id}', 'buyer')" class="flex items-center gap-3 px-4 py-3 hover:bg-[#f5f6f6] cursor-pointer border-b border-gray-100">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl flex-shrink-0">
                            ${order.items[0]?.emoji || 'ğŸ“¦'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <p class="font-medium text-[17px] text-gray-900 truncate">${storeData?.name || 'Penjual'}</p>
                                <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${time}</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="wa-check-read text-xs">âœ“âœ“</span>
                                <p class="text-sm text-gray-500 truncate">${statusLabels[order.status] || order.status}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChatListSeller() {
            const container = document.getElementById('chatOrderListSeller');
            
            if (ordersCache.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center text-gray-400">
                        <span class="text-3xl block mb-2">ğŸ“­</span>
                        <p class="text-sm">Belum ada order</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = ordersCache.map(order => {
                const time = new Date(order.createdAt).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const statusLabels = {
                    pending: 'Order baru masuk',
                    waiting_buyer: 'Menunggu konfirmasi pembeli',
                    waiting_payment: 'Menunggu pembayaran',
                    processing: 'Sedang diproses',
                    shipped: 'Dalam pengiriman',
                    completed: 'Selesai',
                    cancelled: 'Dibatalkan'
                };
                const unread = order.status === 'pending' || order.status === 'waiting_payment';

                return `
                    <div onclick="openChatFromFloating('${order.id}', 'seller')" class="flex items-center gap-3 px-4 py-3 hover:bg-[#f5f6f6] cursor-pointer border-b border-gray-100">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-xl font-semibold text-gray-600 flex-shrink-0">
                            ${order.buyerName?.charAt(0)?.toUpperCase() || 'P'}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline">
                                <p class="font-medium text-[17px] text-gray-900 truncate">${order.buyerName || 'Pembeli'}</p>
                                <span class="text-xs ${unread ? 'text-[#25d366] font-medium' : 'text-gray-500'} flex-shrink-0 ml-2">${time}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-500 truncate">${statusLabels[order.status] || order.status}</p>
                                ${unread ? '<span class="bg-[#25d366] text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-medium flex-shrink-0">1</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openChatFromFloating(orderId, role) {
            // Tutup list
            document.getElementById('chatListBuyer')?.classList.add('hidden');
            document.getElementById('chatListSeller')?.classList.add('hidden');
            
            // Buka chat internal
            openInternalChat(orderId);
        }

        // ==================== INTERNAL CHAT ====================
        let currentChatOrderId = null;
        let unsubscribeChat = null;

        // Typing indicator
        let typingTimeout = null;
        let isTyping = false;

        function handleTyping() {
            // Show typing indicator to partner (simulated)
            if (!isTyping && currentChatOrderId) {
                isTyping = true;
                // In real app, update Firebase with typing status
            }
            
            // Clear previous timeout
            if (typingTimeout) clearTimeout(typingTimeout);
            
            // Set timeout to stop typing indicator
            typingTimeout = setTimeout(() => {
                isTyping = false;
            }, 2000);
        }

        function showTypingIndicator(show = true) {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.classList.toggle('hidden', !show);
            }
        }

        function openInternalChat(orderId) {
            const order = ordersCache.find(o => o.id === orderId);
            if (!order) return;

            currentChatOrderId = orderId;

            // Set chat info
            document.getElementById('chatOrderId').textContent = orderId;
            
            // Set order status
            const statusLabels = {
                pending: 'â³ Pending',
                waiting_buyer: 'ğŸ”” Menunggu',
                waiting_payment: 'ğŸ’° Bayar',
                processing: 'ğŸ”„ Proses',
                shipped: 'ğŸšš Dikirim',
                completed: 'âœ… Selesai',
                cancelled: 'âŒ Batal'
            };
            document.getElementById('chatOrderStatus').textContent = statusLabels[order.status] || order.status;

            // Determine chat partner based on current user role
            if (currentUserData?.role === 'seller') {
                // Penjual chat dengan pembeli
                document.getElementById('chatPartnerAvatar').textContent = order.buyerName?.charAt(0)?.toUpperCase() || 'P';
                document.getElementById('chatPartnerAvatar').className = 'w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold text-lg';
                document.getElementById('chatPartnerName').textContent = order.buyerName || 'Pembeli';
                document.getElementById('chatPartnerStatus').textContent = 'online â€¢ ' + (order.buyerPhone || '');
            } else {
                // Pembeli chat dengan penjual
                document.getElementById('chatPartnerAvatar').textContent = storeData?.name?.charAt(0)?.toUpperCase() || 'T';
                document.getElementById('chatPartnerAvatar').className = 'w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 font-bold text-lg';
                document.getElementById('chatPartnerName').textContent = storeData?.name || 'Penjual';
                document.getElementById('chatPartnerStatus').textContent = 'online â€¢ ' + (storeData?.phone || '');
            }

            // Open modal
            document.getElementById('chatModal').classList.remove('hidden');
            document.getElementById('chatModal').classList.add('flex');

            // Load messages
            loadChatMessages(orderId);

            // Focus on input
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 300);
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.add('hidden');
            document.getElementById('chatModal').classList.remove('flex');
            currentChatOrderId = null;

            // Unsubscribe from chat listener
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
        }

        function loadChatMessages(orderId) {
            if (!db) return;

            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-400 text-sm py-4">
                    <div class="w-6 h-6 border-2 border-green-500 border-t-transparent rounded-full spinner mx-auto mb-2"></div>
                    <p>Memuat pesan...</p>
                </div>
            `;

            // Unsubscribe previous listener
            if (unsubscribeChat) {
                unsubscribeChat();
            }

            // Listen to messages for this order
            unsubscribeChat = db.collection('chats')
                .where('orderId', '==', orderId)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messages = snapshot.docs.map(doc => doc.data());
                    renderChatMessages(messages);
                    
                    // Mark messages as read
                    markMessagesAsRead(orderId);
                }, error => {
                    console.error('Error loading messages:', error);
                    // Fallback tanpa orderBy jika index belum dibuat
                    db.collection('chats')
                        .where('orderId', '==', orderId)
                        .get()
                        .then(snapshot => {
                            const messages = snapshot.docs.map(doc => doc.data());
                            messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                            renderChatMessages(messages);
                        });
                });
        }

        function renderChatMessages(messages) {
            const container = document.getElementById('chatMessages');

            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <div class="inline-block bg-[#fcf4cb] rounded-lg px-4 py-2 text-sm text-[#54656f] shadow-sm">
                            <span class="text-lg block mb-1">ğŸ”’</span>
                            Pesan terenkripsi end-to-end.<br>
                            Mulai percakapan sekarang!
                        </div>
                    </div>
                `;
                return;
            }

            // Group messages by date
            const groupedMessages = {};
            messages.forEach(msg => {
                const date = msg.timestamp ? new Date(msg.timestamp) : new Date();
                const dateKey = date.toDateString();
                if (!groupedMessages[dateKey]) {
                    groupedMessages[dateKey] = [];
                }
                groupedMessages[dateKey].push(msg);
            });

            let html = '';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            Object.keys(groupedMessages).forEach(dateKey => {
                // Date separator
                let dateLabel = dateKey;
                if (dateKey === today) {
                    dateLabel = 'HARI INI';
                } else if (dateKey === yesterday) {
                    dateLabel = 'KEMARIN';
                } else {
                    const d = new Date(dateKey);
                    dateLabel = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                }

                html += `
                    <div class="flex justify-center my-3">
                        <span class="bg-[#e1f2fb] text-[#54656f] text-xs px-3 py-1 rounded-lg shadow-sm">${dateLabel}</span>
                    </div>
                `;

                groupedMessages[dateKey].forEach(msg => {
                    const isMe = msg.senderId === currentUser?.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';
                    const checkMark = isMe ? (msg.read ? '<span class="wa-check-read">âœ“âœ“</span>' : '<span class="wa-check">âœ“âœ“</span>') : '';

                    if (isMe) {
                        // Pesan dari saya (kanan) - WhatsApp green bubble
                        html += `
                            <div class="flex justify-end mb-1">
                                <div class="max-w-[85%] mr-2">
                                    <div class="wa-bubble-out px-3 py-1.5 shadow-sm">
                                        <p class="text-[14.5px] text-gray-800 leading-relaxed">${escapeHtml(msg.message)}</p>
                                        <div class="flex items-center justify-end gap-1 -mb-0.5 mt-0.5">
                                            <span class="wa-time">${time}</span>
                                            ${checkMark}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Pesan dari partner (kiri) - white bubble
                        const senderColor = msg.senderRole === 'seller' ? 'text-[#06cf9c]' : 'text-[#ff6b6b]';
                        html += `
                            <div class="flex justify-start mb-1">
                                <div class="max-w-[85%] ml-2">
                                    <div class="wa-bubble-in px-3 py-1.5 shadow-sm">
                                        <p class="text-xs font-medium ${senderColor} mb-0.5">${escapeHtml(msg.senderName)}</p>
                                        <p class="text-[14.5px] text-gray-800 leading-relaxed">${escapeHtml(msg.message)}</p>
                                        <div class="flex items-center justify-end -mb-0.5 mt-0.5">
                                            <span class="wa-time">${time}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            });

            container.innerHTML = html;

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !currentChatOrderId || !currentUser) return;

            // Clear input
            input.value = '';

            try {
                const msgId = 'MSG' + Date.now().toString(36).toUpperCase();
                await db.collection('chats').doc(msgId).set({
                    id: msgId,
                    orderId: currentChatOrderId,
                    senderId: currentUser.uid,
                    senderName: currentUserData?.name || 'User',
                    senderRole: currentUserData?.role || 'buyer',
                    message: message,
                    timestamp: Date.now(),
                    read: false
                });
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Gagal mengirim pesan: ' + error.message);
                input.value = message; // Restore message
            }
        }

        async function markMessagesAsRead(orderId) {
            if (!db || !currentUser) return;

            try {
                const unreadMessages = await db.collection('chats')
                    .where('orderId', '==', orderId)
                    .where('read', '==', false)
                    .get();

                const batch = db.batch();
                unreadMessages.docs.forEach(doc => {
                    const msg = doc.data();
                    // Only mark as read if the message is not from current user
                    if (msg.senderId !== currentUser.uid) {
                        batch.update(doc.ref, { read: true });
                    }
                });
                await batch.commit();
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        // Update unread count for floating button
        function updateUnreadChatCount() {
            if (!db || !currentUser) return;

            // Get all orders for current user
            const orderIds = ordersCache.map(o => o.id);
            if (orderIds.length === 0) return;

            // Count unread messages not sent by current user
            db.collection('chats')
                .where('read', '==', false)
                .get()
                .then(snapshot => {
                    let unreadCount = 0;
                    snapshot.docs.forEach(doc => {
                        const msg = doc.data();
                        if (orderIds.includes(msg.orderId) && msg.senderId !== currentUser.uid) {
                            unreadCount++;
                        }
                    });

                    // Update badge
                    const badgeBuyer = document.getElementById('chatBadgeBuyer');
                    const badgeSeller = document.getElementById('chatBadgeSeller');

                    if (badgeBuyer) {
                        if (unreadCount > 0) {
                            badgeBuyer.textContent = unreadCount > 9 ? '9+' : unreadCount;
                            badgeBuyer.classList.remove('hidden');
                        } else {
                            badgeBuyer.classList.add('hidden');
                        }
                    }

                    if (badgeSeller) {
                        if (unreadCount > 0) {
                            badgeSeller.textContent = unreadCount > 9 ? '9+' : unreadCount;
                            badgeSeller.classList.remove('hidden');
                        } else {
                            badgeSeller.classList.add('hidden');
                        }
                    }
                });
        }

        // Call updateUnreadChatCount periodically
        setInterval(updateUnreadChatCount, 5000);

        // Show/hide floating chat based on mode
        function updateFloatingChat() {
            const buyerFloat = document.getElementById('floatingChatBuyer');
            const sellerFloat = document.getElementById('floatingChatSeller');
            
            if (currentMode === 'buyer') {
                buyerFloat?.classList.remove('hidden');
                sellerFloat?.classList.add('hidden');
            } else if (currentMode === 'seller') {
                sellerFloat?.classList.remove('hidden');
                buyerFloat?.classList.add('hidden');
            } else {
                buyerFloat?.classList.add('hidden');
                sellerFloat?.classList.add('hidden');
            }
        }

        // Override setMode to show floating chat
        const originalSetMode = setMode;
        setMode = async function(mode) {
            await originalSetMode(mode);
            updateFloatingChat();
        };

        // Initialize
        initFirebase();
    </script>
</body>
</html>
